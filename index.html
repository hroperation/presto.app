<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู HR ุงููุชูุงูู ุงูุณุญุงุจู - v19.0 (ุงููุณุฎุฉ ุงููุงููุฉ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --accent: #facc15; --bg-main: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-main); color: #1e293b; }
        .sidebar-link { transition: all 0.3s ease; cursor: pointer; }
        .sidebar-link.active { background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%); border-left: 4px solid var(--accent); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .hidden-section { display: none; }
        .stat-card { transition: all 0.3s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .modern-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        input, select, textarea { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.6rem 1rem; width: 100%; transition: all 0.2s; background-color: #fff; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .modal { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal.active { display: flex; }
        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); } 70% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="flex min-h-screen">

    <aside class="w-72 bg-slate-900 text-white flex-shrink-0 hidden lg:flex flex-col shadow-2xl z-50 no-print">
        <div class="p-8">
            <div class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-400">HR PLATFORM โจ</div>
            <p class="text-slate-500 text-[10px] mt-1 font-bold uppercase tracking-widest">ุฅุตุฏุงุฑ ุณุญุงุจู 19.0</p>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <div onclick="showSection('dashboard')" id="link-dashboard" class="sidebar-link flex items-center p-3 rounded-xl hover:bg-slate-800 active"><span class="ml-3 font-bold">๐ ููุญุฉ ุงูุชุญูู</span></div>
            <div onclick="showSection('employees')" id="link-employees" class="sidebar-link flex items-center p-3 rounded-xl hover:bg-slate-800"><span class="ml-3 font-bold">๐ฅ ุฅุฏุงุฑุฉ ุงูููุธููู</span></div>
            
            <div class="pt-10 px-3 space-y-2">
                <button onclick="downloadBackup()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 text-[10px] py-3 rounded-xl border border-slate-700 font-bold transition-all flex items-center justify-center gap-2">๐พ ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                <button onclick="document.getElementById('importFile').click()" class="w-full bg-emerald-900/50 hover:bg-emerald-800 text-emerald-200 text-[10px] py-3 rounded-xl border border-emerald-700 font-bold transition-all flex items-center justify-center gap-2">๐ฅ ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importBackup(event)">
                <button onclick="openModal('modalExportOvertime')" class="w-full bg-orange-800/50 hover:bg-orange-700 text-orange-100 text-[10px] py-3 rounded-xl border border-orange-700 font-bold transition-all flex items-center justify-center gap-2">๐ ุชูุฑูุฑ ุงูุฅุถุงูู ุงูุดุงูู</button>
            </div>
        </nav>
        <div class="p-6 border-t border-slate-800">
            <div class="flex items-center gap-3 bg-slate-800/50 p-4 rounded-2xl text-[11px]">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold">M</div>
                <div><p class="font-bold text-white">ูุฏูุฑ ุงููุธุงู</p><p class="text-slate-400" id="current-date-display"></p></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-40 sticky top-0 no-print">
            <h2 id="section-title" class="text-xl font-extrabold text-slate-800">ููุญุฉ ุงูุชุญูู</h2>
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-end">
                    <span class="text-[9px] font-bold text-blue-600">ุชุงุฑูุฎ ุงููุธุงู ุงูุญุงูู</span>
                    <input type="date" id="systemDateSelector" onchange="updateSystemDate()" class="text-xs py-1.5 w-40">
                </div>
                <button onclick="showSection('add-employee-form')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg transition-all">+ ููุธู ุฌุฏูุฏ</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 print-area">
            
            <section id="dashboard" class="space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 no-print">
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-slate-400 font-bold text-[10px] uppercase">ุงูููุธููู</p><h3 class="text-3xl font-black text-slate-800" id="stat-emp-count">0</h3></div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-red-500 font-bold text-[10px] uppercase">ุงูุฅูุฐุงุฑุงุช</p><h3 class="text-3xl font-black text-red-600" id="stat-action-count">0</h3></div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-emerald-500 font-bold text-[10px] uppercase">ุงูุฅุฌุงุฒุงุช</p><h3 class="text-3xl font-black text-emerald-600" id="stat-leave-count">0</h3></div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-blue-500 font-bold text-[10px] uppercase">ุงูููุงู ุงูููุฌุฒุฉ</p><h3 class="text-3xl font-black text-blue-600" id="stat-task-count">0</h3></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <div class="lg:col-span-3 bg-white rounded-[2.5rem] border modern-shadow overflow-hidden">
                        <div class="p-8 border-b bg-slate-50/30 font-black text-slate-800 flex justify-between"><span>๐๏ธ ุฎุฑูุทุฉ ุงูุฏูุงู ุงูุฃุณุจูุนู</span><span id="week-range-text" class="text-xs text-slate-400"></span></div>
                        <div class="overflow-x-auto"><table class="w-full text-right border-collapse"><thead class="bg-slate-50 text-[10px] text-slate-500 uppercase font-black"><tr id="dashHeadRow"></tr></thead><tbody id="dashTableBody" class="text-[11px] font-bold divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div class="bg-white rounded-[2.5rem] border modern-shadow overflow-hidden h-fit no-print">
                        <div class="p-6 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-black">๐ ุฃุนูุงุฏ ูููุงุฏ ุงูุดูุฑ</div>
                        <div id="birthdayList" class="p-6 space-y-4"></div>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border modern-shadow overflow-hidden">
                    <div class="p-8 border-b bg-slate-50 font-black flex justify-between items-center"><span>๐ ุฌุฏูู ุงูุฅุฌุงุฒุงุช ุงูุณููู</span><span class="text-[10px] bg-red-100 text-red-600 px-3 py-1 rounded-full">ูุงุดู ุงูุชุนุงุฑุถุงุช</span></div>
                    <div class="overflow-x-auto max-h-80"><table class="w-full text-right border-collapse"><thead class="bg-slate-50 text-[10px] text-slate-500 sticky top-0 z-10 uppercase"><tr><th class="p-4">ุชุงุฑูุฎ ุงูุฅุฌุงุฒุฉ</th><th class="p-4">ุงูููุธููู ุงููุญุฌูุฒูู</th><th class="p-4 text-center">ุงูุญุงูุฉ</th></tr></thead><tbody id="yearlyLeavesTable" class="text-xs font-bold divide-y divide-slate-50"></tbody></table></div>
                </div>
            </section>

            <section id="employees" class="hidden-section space-y-6">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm flex items-center gap-4"><input type="text" id="empSearch" onkeyup="searchEmployees()" placeholder="ุงุจุญุซ ุจุงุณู ุงูููุธู ุฃู ุงููุณู..." class="bg-slate-50 border-none flex-1"></div>
                <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm"><table class="w-full text-right border-collapse"><thead class="bg-slate-50 text-xs text-slate-500 uppercase font-black"><tr><th class="p-5">ุงูุงุณู ุงููุงูู</th><th class="p-5">ุงููุณู</th><th class="p-5 text-center">ุงูุฅุฌุฑุงุก</th></tr></thead><tbody id="employeesTableBody" class="font-bold divide-y divide-slate-100"></tbody></table></div>
            </section>

            <section id="add-employee-form" class="hidden-section max-w-5xl mx-auto no-print">
                <div class="bg-white p-10 rounded-[3rem] border shadow-xl">
                    <h2 class="text-3xl font-black text-blue-800 mb-8 flex justify-between items-center"><span>ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ</span><button onclick="showSection('dashboard')" class="text-xs bg-slate-100 px-3 py-1 rounded-lg">ุฑุฌูุน</button></h2>
                    <form id="fullEmployeeForm" onsubmit="saveNewEmployee(event)" class="space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 font-bold text-xs">
                            <div><label>ุงูุงุณู ุงููุงูู</label><input type="text" id="f_name" required></div>
                            <div><label>ุงูุฑูู ุงููุธููู</label><input type="text" id="f_id" required></div>
                            <div><label>ุชุงุฑูุฎ ุงููููุงุฏ</label><input type="date" id="f_dob"></div>
                            <div><label>ุงููุณู</label><input type="text" id="f_dept"></div>
                            <div><label>ุงููุณูู ุงููุธููู</label><input type="text" id="f_pos"></div>
                            <div><label>ุงููุฑุชุจ</label><input type="number" id="f_salary"></div>
                            <div><label>ุชุงุฑูุฎ ุจุฏุก ุงูุนูู</label><input type="date" id="f_start_date" onchange="updateDurationInForm()"></div>
                            <div class="md:col-span-2"><label class="text-blue-600">ูุฏุฉ ุงูุฎุฏูุฉ (ุชููุงุฆู)</label><div id="form_duration_result" class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-blue-800 h-[45px] flex items-center">--</div></div>
                            <div><label>ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช</label><input type="number" id="f_leave_bal" value="30"></div>
                            <div><label>ุฑูู ุงููุงุชู</label><input type="tel" id="f_phone"></div>
                            <div><label>ุงูุนููุงู</label><input type="text" id="f_address"></div>
                            <div><label>ูุตููุฉ ุงูุฏู</label><input type="text" id="f_blood"></div>
                            <div><label>ุงูุฌูุณูุฉ</label><input type="text" id="f_nat"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black text-xl shadow-lg">ุญูุธ ุงูููู ุจุงููุงูู ุณุญุงุจูุงู</button>
                    </form>
                </div>
            </section>

            <section id="employee-profile" class="hidden-section space-y-8 pb-10">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-5">
                        <button onclick="showSection('employees')" class="w-14 h-14 bg-white rounded-3xl shadow-sm flex items-center justify-center text-slate-400 font-black no-print">โฌ๏ธ</button>
                        <div><h2 class="text-3xl font-black text-slate-800" id="p-name">--</h2><p class="text-blue-600 font-black text-sm" id="p-job">--</p></div>
                    </div>
                    <div class="flex flex-wrap gap-2 no-print">
                        <button onclick="window.print()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black">๐จ๏ธ ุทุจุงุนุฉ</button>
                        <button onclick="analyzePerformanceAI()" class="bg-purple-600 text-white px-4 py-2 rounded-xl text-[10px] font-black ai-pulse">โจ AI ุชุญููู</button>
                        <button id="p-edit-btn" onclick="toggleEditProfile()" class="bg-slate-500 text-white px-4 py-2 rounded-xl text-[10px] font-black">โ๏ธ ุชุนุฏูู</button>
                        <button id="p-save-btn" onclick="saveProfileChanges()" class="hidden bg-emerald-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">๐พ ุญูุธ</button>
                        <button onclick="openModal('modalSchedule')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">๐ ุงูุฏูุงู</button>
                        <button onclick="openModal('modalAction')" class="bg-red-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">โ๏ธ ุฅูุฐุงุฑ</button>
                        <button onclick="openModal('modalTask')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">๐ ูููุฉ</button>
                        <button onclick="prepareOvertimeModal()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-[10px] font-black">โณ ุฅุถุงูู</button>
                        <button onclick="openModal('modalLeave')" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] font-black">๐ด ุฅุฌุงุฒุฉ</button>
                        <button onclick="deleteProfile()" class="bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-xl text-[10px] font-black transition">๐๏ธ ุญุฐู</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 font-bold">
                    <div class="lg:col-span-4 space-y-8">
                        <div class="bg-white rounded-[2.5rem] border shadow-sm overflow-hidden text-center pb-8">
                            <div class="h-24 bg-gradient-to-br from-blue-700 to-indigo-800"></div>
                            <div class="w-24 h-24 bg-white rounded-full mx-auto -mt-12 flex items-center justify-center text-4xl text-blue-600 font-black shadow-lg" id="p-avatar">?</div>
                            <h3 class="text-xl font-black mt-4" id="p-card-name">--</h3>
                            <div class="mt-6 flex justify-around border-t pt-4 px-4 text-[10px]">
                                <div><p class="text-slate-400">ุฅูุฐุงุฑุงุช</p><p class="text-red-600 text-lg" id="p-stat-act">0</p></div>
                                <div><p class="text-slate-400">ููุงู</p><p class="text-blue-600 text-lg" id="p-stat-task">0</p></div>
                                <div><p class="text-slate-400">ุฅุฌุงุฒุงุช</p><p class="text-emerald-600 text-lg" id="p-stat-leave">0</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm">
                            <h4 class="font-black text-slate-800 mb-6 text-xs flex items-center gap-2">๐ ุงูุฏูุงู ุงูุฃุณุจูุนู</h4>
                            <div id="p-schedule-list" class="space-y-3 text-[10px]"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-8 space-y-8">
                        <div class="bg-white p-10 rounded-[3rem] border shadow-sm">
                            <h3 class="font-black text-slate-800 mb-8 border-b pb-4 text-xl">๐ ุงูุณุฌู ุงููุนูููุงุชู</h3>
                            <div id="p-info-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 text-sm"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 no-print">
                            <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm"><div class="p-5 bg-red-50 text-red-700 font-black text-xs border-b">โ๏ธ ุงูุฅูุฐุงุฑุงุช</div><table class="w-full text-right text-[10px]"><tbody id="p-act-table" class="divide-y divide-slate-50"></tbody></table></div>
                            <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm"><div class="p-5 bg-emerald-50 text-emerald-700 font-black text-xs border-b">๐ด ุงูุฅุฌุงุฒุงุช</div><table class="w-full text-right text-[10px]"><tbody id="p-leave-table" class="divide-y divide-slate-50"></tbody></table></div>
                        </div>

                        <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm no-print">
                            <div class="p-5 bg-orange-50 text-orange-700 font-black text-xs border-b flex justify-between items-center">
                                <span>โณ ุณุฌู ุงูุฅุถุงูู (ุญุฏ 20 ุณุงุนุฉ)</span>
                                <span id="p-over-stat" class="text-[9px] bg-white px-2 py-1 rounded border border-orange-200"></span>
                            </div>
                            <table class="w-full text-right text-[10px] font-bold"><thead class="bg-slate-50 text-slate-400 border-b"><tr><th class="p-3">ุงูุชุงุฑูุฎ</th><th class="p-3">ุงูุณุงุนุงุช</th><th class="p-3">ุงูุณุจุจ</th><th class="p-3 text-left">ุญุฐู</th></tr></thead><tbody id="p-over-table" class="divide-y divide-slate-50"></tbody></table>
                        </div>

                        <div class="bg-white rounded-[2.5rem] border overflow-hidden shadow-sm no-print">
                            <div class="p-6 bg-slate-900 text-white font-black flex justify-between items-center text-xs">
                                <span>๐ ุณุฌู ุชูููู ุงูููุงู</span>
                                <select id="p-task-filter" onchange="applyTaskFilter()" class="bg-slate-800 text-white text-[9px] border-none rounded-lg w-auto py-1">
                                    <option value="ุงููู">ููุชุฑุฉ: ุงููู</option>
                                    <option value="ุนูููุงุช">ุนูููุงุช</option>
                                    <option value="ุฑุณุงุฆู ุงูุตูุญุฉ + ุชุทุจูู ุงูุนููู">ุฑุณุงุฆู ุงูุตูุญุฉ + ุชุทุจูู ุงูุนููู</option>
                                    <option value="ุงูููุงููุงุช">ุงูููุงููุงุช</option>
                                    <option value="ุฑุณุงุฆู ุชุทุจูู ุจุฑูุณุชููุงู">ุฑุณุงุฆู ุชุทุจูู ุจุฑูุณุชููุงู</option>
                                    <option value="ุงูุชู">ุงูุชู</option>
                                    <option value="ูููุชุงูุช">ูููุชุงูุช</option>
                                    <option value="ูุชุงุจุนุฉ">ูุชุงุจุนุฉ</option>
                                </select>
                            </div>
                            <table class="w-full text-right text-[10px] font-bold"><thead class="bg-slate-50 text-slate-500 border-b"><tr><th class="p-4">ุงูุชุงุฑูุฎ</th><th class="p-4">ุงููููุฉ</th><th class="p-4 text-center">ุฌูุฏุฉ%</th><th class="p-4 text-center">ุงูุนุฏุฏ</th></tr></thead><tbody id="p-task-table" class="divide-y divide-slate-50"></tbody></table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="modalExportOvertime" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative shadow-2xl"><button onclick="closeModal('modalExportOvertime')" class="absolute top-6 left-6 text-slate-400 hover:text-red-500 font-black text-xl">โ</button><h3 class="text-xl font-black mb-6">๐ฅ ุชุญููู ุชูุฑูุฑ ุงูุฅุถุงูู</h3><div class="space-y-4 text-xs font-bold"><div class="bg-slate-50 p-4 rounded-xl text-slate-500 border">ุณูุชู ุชุญููู ููู Excel ูููุชุฑุฉ ุงููุญุฏุฏุฉ ูุฌููุน ุงูููุธููู.</div><div class="grid grid-cols-2 gap-4"><div><label>ูู ุชุงุฑูุฎ</label><input type="date" id="exp_start"></div><div><label>ุฅูู ุชุงุฑูุฎ</label><input type="date" id="exp_end"></div></div><button onclick="downloadOvertimeExcel()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black mt-4 flex justify-center gap-2 items-center shadow-lg">๐ ุชุญููู ููู Excel</button></div></div></div>

    <div id="modalAI" class="modal"><div class="bg-white rounded-[2.5rem] w-full max-w-2xl p-8 max-h-[90vh] overflow-hidden flex flex-col relative"><button onclick="closeModal('modalAI')" class="absolute top-6 left-6 text-slate-400 font-black text-xl">โ</button><div class="p-4 bg-purple-700 text-white font-black rounded-t-xl">โจ Gemini AI ุงูุชุญูููู</div><div id="aiResContent" class="p-6 overflow-y-auto flex-1 font-bold text-sm leading-relaxed text-slate-700"></div></div></div>

    <div id="modalSchedule" class="modal"><div class="bg-white rounded-[2.5rem] w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto relative shadow-2xl"><button onclick="closeModal('modalSchedule')" class="absolute top-6 left-6 text-slate-400 font-black text-xl">โ</button><h3 class="text-xl font-black text-indigo-700 border-b pb-4 mb-6">ุชุฎุตูุต ุงูุฏูุงู ุงูุฃุณุจูุนู</h3><div id="scheduleInputs" class="space-y-4"></div><button onclick="saveWeeklySchedule()" class="w-full bg-indigo-700 text-white py-4 rounded-2xl font-black mt-8 shadow-lg">ุญูุธ ุงูุชุบููุฑุงุช</button></div></div>

    <div id="modalLeave" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative shadow-2xl"><button onclick="closeModal('modalLeave')" class="absolute top-6 left-6 text-slate-400 font-black">โ</button><h3 class="text-xl font-black text-emerald-600 mb-6">ุทูุจ ุฅุฌุงุฒุฉ</h3><div class="space-y-4 text-xs font-bold"><input type="hidden" id="l_index"><div><label>ุงูููุน</label><select id="l_type"><option>ูุฑุถูุฉ</option><option>ุทุงุฑุฆุฉ</option><option>ุณูููุฉ</option></select></div><div class="grid grid-cols-2 gap-4"><div><label>ูู</label><input type="date" id="l_from"></div><div><label>ุฅูู</label><input type="date" id="l_to"></div></div><textarea id="l_reason" placeholder="ุงูุชูุงุตูู"></textarea><button onclick="saveLeave()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black mt-4 shadow-lg">ุญูุธ ุงูุฅุฌุงุฒุฉ</button></div></div></div>

    <div id="modalOvertime" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative shadow-2xl"><button onclick="closeModal('modalOvertime')" class="absolute top-6 left-6 text-slate-400 font-black">โ</button><h3 class="text-xl font-black text-orange-600 mb-6">ุชุณุฌูู ุณุงุนุงุช ุฅุถุงูู</h3><div class="bg-orange-50 p-4 rounded-xl mb-4 text-center border font-black text-orange-800">ุงูุฑุตูุฏ ุงููุชุงุญ: <span id="over_rem_disp" class="text-lg text-orange-600">--</span> ุณุงุนุฉ</div><div class="space-y-4 text-xs font-bold"><div><label>ุงูุชุงุฑูุฎ</label><input type="date" id="o_date"></div><div><label>ุนุฏุฏ ุงูุณุงุนุงุช</label><input type="number" id="o_hrs" placeholder="1 - 20"></div><div><label>ุงูุณุจุจ</label><select id="o_reason"><option>ููุต ุงุฐู</option><option>ููุต ุงุฌุงุฒุฉ</option><option>ุถุบุท ุนูู</option><option>ุญุฑุจ</option></select></div><button onclick="saveOvertime()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-black mt-4 shadow-lg">ุญูุธ ุงูุณุงุนุงุช</button></div></div></div>

    <div id="modalAction" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative shadow-2xl"><button onclick="closeModal('modalAction')" class="absolute top-6 left-6 text-slate-400 font-black">โ</button><h3 class="text-xl font-black text-red-600 mb-6">ุฅุฌุฑุงุก ุฅูุฐุงุฑ</h3><div class="space-y-4 text-xs font-bold"><div><label>ููุน ุงูุฅุฌุฑุงุก</label><select id="a_type"><option>ุชุฃุฎูุฑ</option><option>ููุช ูุธุฑ</option><option>ุฅูุฐุงุฑ ุดููู</option><option>ุฅูุฐุงุฑ ูุชุงุจู</option></select></div><div><label>ุงูุชุงุฑูุฎ</label><input type="date" id="a_date"></div><textarea id="a_reason" placeholder="ุงูุณุจุจ"></textarea><button onclick="saveAction()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black mt-4 shadow-lg">ุญูุธ ุงูุฅุฌุฑุงุก</button></div></div></div>

    <div id="modalTask" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative shadow-2xl"><button onclick="closeModal('modalTask')" class="absolute top-6 left-6 text-slate-400 font-black">โ</button><h3 class="text-xl font-black text-blue-600 mb-6">ุชูููู ูููุฉ ููุฌุฒุฉ</h3><div class="space-y-4 text-xs font-bold"><div><label>ููุน ุงููููุฉ</label><select id="t_type"><option>ุนูููุงุช</option><option>ุฑุณุงุฆู ุงูุตูุญุฉ + ุชุทุจูู ุงูุนููู</option><option>ุงูููุงููุงุช</option><option>ุฑุณุงุฆู ุชุทุจูู ุจุฑูุณุชููุงู</option><option>ุงูุชู</option><option>ูููุชุงูุช</option><option>ูุชุงุจุนุฉ</option></select></div><div class="grid grid-cols-2 gap-4"><div><label>ุฌูุฏุฉ ุงูุนูู %</label><input type="number" id="t_qual" value="100"></div><div><label>ุงูุนุฏุฏ ุงูููุฌุฒ</label><input type="number" id="t_count" value="10"></div></div><div><label>ุงูุชุงุฑูุฎ</label><input type="date" id="t_date"></div><button onclick="saveTask()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black mt-4 shadow-lg">ุญูุธ ุงูุชูููู</button></div></div></div>

    <script>
        // --- 1. Firebase & Global State ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAe-WjGh9PtL932wxJPgLSuaslmJWaDC8",
            authDomain: "hr-operation.firebaseapp.com",
            projectId: "hr-operation",
            storageBucket: "hr-operation.firebasestorage.app",
            messagingSenderId: "498775599728",
            appId: "1:498775599728:web:b195dea758f3cf415162b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const empCol = db.collection('employees');

        const weekDays = ["ุงูุณุจุช", "ุงูุฃุญุฏ", "ุงูุงุซููู", "ุงูุซูุงุซุงุก", "ุงูุฃุฑุจุนุงุก", "ุงูุฎููุณ", "ุงูุฌูุนุฉ"];
        const shifts = [
            { label: "08:00 - 03:00", from: "08:00", to: "15:00" },
            { label: "09:00 - 04:00", from: "09:00", to: "16:00" },
            { label: "12:00 - 07:00", from: "12:00", to: "19:00" },
            { label: "04:00 - 11:00", from: "16:00", to: "23:00" },
            { label: "07:00 - 02:00", from: "19:00", to: "02:00" }
        ];

        let employees = [];
        let currentEmpId = null;
        let systemDate = localStorage.getItem('sys_date') ? new Date(localStorage.getItem('sys_date')) : new Date();

        // --- 2. Live Sync & Stats ---
        function initApp() {
            updateSystemDateUI();
            empCol.onSnapshot(snap => {
                employees = snap.docs.map(doc => ({ fsId: doc.id, ...doc.data() }));
                refreshAllUIs();
            });
        }

        async function syncEmp(emp) {
            const { fsId, ...data } = emp;
            await empCol.doc(fsId).update(data);
        }

        function refreshAllUIs() {
            updateDashboardStats();
            if(!document.getElementById('dashboard').classList.contains('hidden-section')) {
                renderDashboardSchedule();
                renderUpcomingBirthdays();
                renderYearlyLeaves();
            }
            if(!document.getElementById('employees').classList.contains('hidden-section')) renderEmployeeList();
            if(!document.getElementById('employee-profile').classList.contains('hidden-section') && currentEmpId) viewProfile(currentEmpId);
        }

        // --- 3. Navigation & System Date ---
        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            if(document.getElementById('link-'+id)) document.getElementById('link-'+id).classList.add('active');
            refreshAllUIs();
        }

        function updateSystemDateUI() {
            document.getElementById('systemDateSelector').value = systemDate.toISOString().split('T')[0];
            document.getElementById('current-date-display').innerText = systemDate.toLocaleDateString('ar-EG', { weekday:'long', day:'numeric', month:'long' });
        }

        function updateSystemDate() {
            const val = document.getElementById('systemDateSelector').value;
            if(val) {
                systemDate = new Date(val);
                localStorage.setItem('sys_date', val);
                updateSystemDateUI();
                refreshAllUIs();
            }
        }

        // --- 4. Logic Functions (Dates, Duration, Conflicts) ---
        function calculateDuration(startStr) {
            if(!startStr) return "--";
            const start = new Date(startStr);
            const today = new Date(systemDate);
            if(start > today) return "ุชุงุฑูุฎ ูุณุชูุจูู";
            let y = today.getFullYear() - start.getFullYear();
            let m = today.getMonth() - start.getMonth();
            let d = today.getDate() - start.getDate();
            if(d < 0) { d += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); m--; }
            if(m < 0) { m += 12; y--; }
            return `${y} ุณูุฉ ู ${m} ุดูุฑ ู ${d} ููู`;
        }

        function updateDurationInForm() {
            document.getElementById('form_duration_result').innerText = calculateDuration(document.getElementById('f_start_date').value);
        }

        function getDatesInRange(s, e) {
            let dates = []; let cur = new Date(s); const end = new Date(e);
            while(cur <= end) { dates.push(cur.toISOString().split('T')[0]); cur.setDate(cur.getDate()+1); }
            return dates;
        }

        function getWeekDates() {
            const base = new Date(systemDate);
            const day = base.getDay();
            const diff = (day === 6) ? 0 : (day + 1);
            const start = new Date(base);
            start.setDate(base.getDate() - diff);
            return Array.from({length:7}, (_,i) => {
                const d = new Date(start); d.setDate(start.getDate() + i);
                return d.toISOString().split('T')[0];
            });
        }

        // --- 5. Dashboard Rendering ---
        function updateDashboardStats() {
            document.getElementById('stat-emp-count').innerText = employees.length;
            let a=0, l=0, t=0;
            employees.forEach(e => { a+=(e.actions||[]).length; l+=(e.leaves||[]).length; t+=(e.tasks||[]).length; });
            document.getElementById('stat-action-count').innerText = a;
            document.getElementById('stat-leave-count').innerText = l;
            document.getElementById('stat-task-count').innerText = t;
        }

        function renderDashboardSchedule() {
            const dates = getWeekDates();
            document.getElementById('week-range-text').innerText = `${dates[0]} ุฅูู ${dates[6]}`;
            let head = `<th class="p-4 border-l bg-slate-50 sticky right-0">ุงูุดูุช</th>`;
            weekDays.forEach((d, i) => {
                head += `<th class="p-4 text-center"><div>${d}</div><div class="text-[9px] font-normal text-slate-400">${dates[i].split('-')[2]}/${dates[i].split('-')[1]}</div></th>`;
            });
            document.getElementById('dashHeadRow').innerHTML = head;

            document.getElementById('dashTableBody').innerHTML = shifts.map(sh => `
                <tr>
                    <td class="p-4 border-l bg-slate-50 sticky right-0 font-black text-slate-600 text-center">${sh.label}</td>
                    ${weekDays.map(day => {
                        const emps = employees.filter(e => {
                            const s = e.schedule[day];
                            return s && s.type !== 'ุนุทูุฉ' && s.from === sh.from && s.to === sh.to;
                        });
                        return `<td class="p-2 align-top">${emps.map(e => `<div class="text-blue-600 py-1">โข ${e.name}</div>`).join('')}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }

        function renderUpcomingBirthdays() {
            const curMonth = new Date(systemDate).getMonth();
            const list = employees.filter(e => e.details['ุชุงุฑูุฎ ุงููููุงุฏ'] && new Date(e.details['ุชุงุฑูุฎ ุงููููุงุฏ']).getMonth() === curMonth);
            document.getElementById('birthdayList').innerHTML = list.map(e => `
                <div class="p-3 bg-slate-50 rounded-xl flex justify-between font-black text-xs border border-slate-100">
                    <span>${e.name}</span><span class="text-blue-600">${e.details['ุชุงุฑูุฎ ุงููููุงุฏ']}</span>
                </div>
            `).join('') || '<p class="text-center text-xs text-slate-300 italic">ูุง ููุฌุฏ ูุฐุง ุงูุดูุฑ</p>';
        }

        function renderYearlyLeaves() {
            const all = [];
            employees.forEach(e => (e.leaves||[]).forEach(l => {
                getDatesInRange(l.from, l.to).forEach(d => all.push({ date: d, emp: e.name, type: l.type }));
            }));
            const grouped = {};
            all.forEach(x => { if(!grouped[x.date]) grouped[x.date] = []; grouped[x.date].push(x); });
            document.getElementById('yearlyLeavesTable').innerHTML = Object.keys(grouped).sort().map(d => {
                const conflict = grouped[d].length > 1;
                return `<tr class="${conflict?'bg-red-50':''}">
                    <td class="p-4">${d}</td>
                    <td class="p-4 flex flex-wrap gap-2">${grouped[d].map(g => `<span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${g.emp} (${g.type})</span>`).join('')}</td>
                    <td class="p-4 text-center">${conflict?'<span class="text-red-600">โ๏ธ ุชุนุงุฑุถ</span>':'<span class="text-emerald-600">ูุชุงุญ</span>'}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="3" class="p-8 text-center text-slate-300">ูุง ุชูุฌุฏ ุฅุฌุงุฒุงุช ูุญุฌูุฒุฉ</td></tr>';
        }

        // --- 6. Employee Operations ---
        async function saveNewEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('f_id').value;
            if(employees.some(x => x.id == id)) return alert("ุงูุฑูู ูุณุฌู!");
            const data = {
                id, name: document.getElementById('f_name').value,
                details: {
                    "ุงููุณู": document.getElementById('f_dept').value, "ุงููุณูู": document.getElementById('f_pos').value,
                    "ุงูุฑุงุชุจ": document.getElementById('f_salary').value, "ุจุฏุงูุฉ ุงูุนูู": document.getElementById('f_start_date').value,
                    "ุชุงุฑูุฎ ุงููููุงุฏ": document.getElementById('f_dob').value, "ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช": document.getElementById('f_leave_bal').value,
                    "ุงููุงุชู": document.getElementById('f_phone').value, "ุงูุนููุงู": document.getElementById('f_address').value,
                    "ูุตููุฉ ุงูุฏู": document.getElementById('f_blood').value, "ุงูุฌูุณูุฉ": document.getElementById('f_nat').value
                },
                schedule: {}, actions: [], tasks: [], leaves: [], overtime: []
            };
            await empCol.add(data);
            alert("ุชู ุงูุญูุธ ุณุญุงุจูุงู โ");
            showSection('dashboard');
        }

        function renderEmployeeList(data = employees) {
            document.getElementById('employeesTableBody').innerHTML = data.map(e => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-5">${e.name} <span class="text-slate-300">#${e.id}</span></td>
                    <td class="p-5 text-slate-500">${e.details['ุงููุณู']}</td>
                    <td class="p-5 text-center"><button onclick="viewProfile('${e.id}')" class="bg-blue-50 text-blue-700 px-8 py-2 rounded-2xl font-black text-xs hover:bg-blue-600 hover:text-white transition">ุนุฑุถ</button></td>
                </tr>
            `).join('');
        }

        function searchEmployees() {
            const val = document.getElementById('empSearch').value.toLowerCase();
            renderEmployeeList(employees.filter(e => e.name.toLowerCase().includes(val) || e.details['ุงููุณู'].toLowerCase().includes(val)));
        }

        // --- 7. Profile View Logic ---
        function viewProfile(id) {
            const emp = employees.find(e => e.id == id);
            if(!emp) return;
            currentEmpId = id;

            document.getElementById('p-name').innerText = emp.name;
            document.getElementById('p-job').innerText = emp.details['ุงููุณูู'];
            document.getElementById('p-card-name').innerText = emp.name;
            document.getElementById('p-avatar').innerText = emp.name[0];

            // Stats
            document.getElementById('p-stat-act').innerText = (emp.actions||[]).length;
            document.getElementById('p-stat-task').innerText = (emp.tasks||[]).length;
            document.getElementById('p-stat-leave').innerText = (emp.leaves||[]).length;

            // Info Grid
            let html = Object.entries(emp.details).map(([k,v]) => `<div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><p class="text-[9px] text-slate-400 font-black uppercase mb-1">${k}</p><p class="text-slate-800 text-xs">${v || '-'}</p></div>`).join('');
            html += `<div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-blue-800"><p class="text-[9px] font-black uppercase mb-1">ูุฏุฉ ุงูุฎุฏูุฉ</p><p class="text-xs font-black">${calculateDuration(emp.details['ุจุฏุงูุฉ ุงูุนูู'])}</p></div>`;
            document.getElementById('p-info-grid').innerHTML = html;

            // Schedule View
            const dates = getWeekDates();
            document.getElementById('p-schedule-list').innerHTML = weekDays.map((d, i) => {
                const s = emp.schedule[d] || {type:'ุนูู', from:'08:00', to:'16:00'};
                return `<div class="flex justify-between items-center p-3 rounded-xl border ${s.type==='ุนุทูุฉ'?'bg-red-50 text-red-600':'bg-slate-50'}"><span>${d}</span><span>${s.type==='ุนุทูุฉ'?'ุฑุงุญุฉ':s.from+' - '+s.to}</span></div>`;
            }).join('');

            renderProfileTables(emp);
            document.getElementById('p-edit-btn').classList.remove('hidden');
            document.getElementById('p-save-btn').classList.add('hidden');
            showSection('employee-profile');
        }

        function renderProfileTables(emp) {
            // Actions
            document.getElementById('p-act-table').innerHTML = (emp.actions||[]).map(a => `<tr class="border-b"><td class="p-3">${a.date}</td><td class="p-3 text-red-600">${a.type}</td><td class="p-3 text-slate-400">${a.reason}</td></tr>`).join('');
            // Leaves
            document.getElementById('p-leave-table').innerHTML = (emp.leaves||[]).map(l => `<tr class="border-b"><td class="p-3">${l.from} / ${l.to}</td><td class="p-3 text-emerald-600">${l.type}</td></tr>`).join('');
            // Overtime
            const overTotal = (emp.overtime||[]).reduce((s,x)=>s+parseFloat(x.hours), 0);
            document.getElementById('p-over-stat').innerText = `ูุณุชุฎุฏู: ${overTotal} | ูุชุจูู: ${20 - overTotal}`;
            document.getElementById('p-over-table').innerHTML = (emp.overtime||[]).map((o, idx) => `<tr class="border-b"><td class="p-3">${o.date}</td><td class="p-3 text-orange-600">${o.hours} ุณุงุนุฉ</td><td class="p-3">${o.reason}</td><td class="p-3 text-left"><button onclick="deleteOvertime(${idx})" class="text-red-400">โ</button></td></tr>`).join('');
            // Tasks
            applyTaskFilter();
        }

        function applyTaskFilter() {
            const emp = employees.find(e => e.id == currentEmpId);
            const filter = document.getElementById('p-task-filter').value;
            let tasks = emp.tasks || [];
            if(filter !== 'ุงููู') tasks = tasks.filter(t => t.type === filter);
            document.getElementById('p-task-table').innerHTML = tasks.map(t => `<tr class="border-b"><td class="p-4">${t.date}</td><td class="p-4">${t.type}</td><td class="p-4 text-center text-blue-600 font-black">${t.quality}%</td><td class="p-4 text-center">${t.count}</td></tr>`).join('') || '<tr><td colspan="4" class="p-8 text-center text-slate-300 italic">ูุง ุชูุฌุฏ ููุงู ูุทุงุจูุฉ</td></tr>';
        }

        // --- 8. Modals Action Saves ---
        async function saveTask() {
            const emp = employees.find(e => e.id == currentEmpId);
            const date = document.getElementById('t_date').value;
            if(!date) return alert("ุงุฎุชุฑ ุงูุชุงุฑูุฎ");
            emp.tasks.push({ type: document.getElementById('t_type').value, quality: document.getElementById('t_qual').value, count: document.getElementById('t_count').value, date });
            await syncEmp(emp);
            closeModal('modalTask');
        }

        async function saveAction() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.actions.push({ type: document.getElementById('a_type').value, date: document.getElementById('a_date').value, reason: document.getElementById('a_reason').value });
            await syncEmp(emp);
            closeModal('modalAction');
        }

        async function saveLeave() {
            const emp = employees.find(e => e.id == currentEmpId);
            const from = document.getElementById('l_from').value;
            const to = document.getElementById('l_to').value;
            if(!from || !to) return alert("ุญุฏุฏ ุงูุชูุงุฑูุฎ");
            const type = document.getElementById('l_type').value;
            const days = Math.ceil(Math.abs(new Date(to) - new Date(from)) / (1000*60*60*24)) + 1;
            if(type === 'ุณูููุฉ' || type === 'ุทุงุฑุฆุฉ') emp.details['ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช'] = parseInt(emp.details['ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช']) - days;
            emp.leaves.push({ from, to, type, reason: document.getElementById('l_reason').value });
            await syncEmp(emp);
            closeModal('modalLeave');
        }

        function prepareOvertimeModal() {
            const emp = employees.find(e => e.id == currentEmpId);
            const used = (emp.overtime||[]).reduce((s,x)=>s+parseFloat(x.hours), 0);
            document.getElementById('over_rem_disp').innerText = 20 - used;
            document.getElementById('o_date').value = systemDate.toISOString().split('T')[0];
            openModal('modalOvertime');
        }

        async function saveOvertime() {
            const emp = employees.find(e => e.id == currentEmpId);
            const hrs = parseFloat(document.getElementById('o_hrs').value);
            const used = (emp.overtime||[]).reduce((s,x)=>s+parseFloat(x.hours), 0);
            if(used + hrs > 20) return alert("ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู (20 ุณุงุนุฉ)!");
            emp.overtime.push({ date: document.getElementById('o_date').value, hours: hrs, reason: document.getElementById('o_reason').value });
            await syncEmp(emp);
            closeModal('modalOvertime');
        }

        async function deleteOvertime(idx) {
            if(confirm("ุญุฐู ุงูุณุฌูุ")) {
                const emp = employees.find(e => e.id == currentEmpId);
                emp.overtime.splice(idx, 1);
                await syncEmp(emp);
            }
        }

        function prepareScheduleModal() {
            const emp = employees.find(e => e.id == currentEmpId);
            document.getElementById('scheduleInputs').innerHTML = weekDays.map(d => {
                const s = emp.schedule[d] || {type:'ุนูู', from:'08:00', to:'16:00'};
                return `
                    <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border font-black text-xs">
                        <span class="w-16">${d}</span>
                        <select id="type-${d}" onchange="toggleDayRow('${d}')" class="w-32"><option value="ุนูู" ${s.type==='ุนูู'?'selected':''}>ุนูู</option><option value="ุนุทูุฉ" ${s.type==='ุนุทูุฉ'?'selected':''}>ุฑุงุญุฉ</option></select>
                        <div id="times-${d}" class="flex gap-2 flex-1 ${s.type==='ุนุทูุฉ'?'opacity-20 pointer-events-none':''}"><input type="time" id="from-${d}" value="${s.from}"><input type="time" id="to-${d}" value="${s.to}"></div>
                    </div>`;
            }).join('');
        }

        async function saveWeeklySchedule() {
            const emp = employees.find(e => e.id == currentEmpId);
            weekDays.forEach(d => {
                emp.schedule[d] = { type: document.getElementById('type-'+d).value, from: document.getElementById('from-'+d).value, to: document.getElementById('to-'+d).value };
            });
            await syncEmp(emp);
            closeModal('modalSchedule');
        }

        function toggleDayRow(d) { document.getElementById('times-'+d).classList.toggle('opacity-20', document.getElementById('type-'+d).value === 'ุนุทูุฉ'); }

        // --- 9. Edit Profile Logic ---
        function toggleEditProfile() {
            const emp = employees.find(e => e.id == currentEmpId);
            document.getElementById('p-edit-btn').classList.add('hidden');
            document.getElementById('p-save-btn').classList.remove('hidden');
            document.getElementById('p-info-grid').innerHTML = `
                <div class="col-span-full mb-4"><label class="text-[10px]">ุงูุงุณู</label><input type="text" id="edit-name" value="${emp.name}"></div>
            ` + Object.entries(emp.details).map(([k,v]) => `<div><label class="text-[10px]">${k}</label><input type="text" id="edit-val-${k}" value="${v||''}"></div>`).join('');
        }

        async function saveProfileChanges() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.name = document.getElementById('edit-name').value;
            Object.keys(emp.details).forEach(k => {
                const input = document.getElementById('edit-val-'+k);
                if(input) emp.details[k] = input.value;
            });
            await syncEmp(emp);
            alert("ุชู ุงูุชุนุฏูู ุณุญุงุจูุงู");
            viewProfile(currentEmpId);
        }

        async function deleteProfile() {
            if(confirm("ุญุฐู ุงูููุธู ููุงุฆูุงูุ")) {
                const emp = employees.find(e => e.id == currentEmpId);
                await empCol.doc(emp.fsId).delete();
                showSection('dashboard');
            }
        }

        // --- 10. External Tools (Excel, AI, Backup) ---
        function downloadOvertimeExcel() {
            const s = document.getElementById('exp_start').value;
            const e = document.getElementById('exp_end').value;
            if(!s || !e) return alert("ุญุฏุฏ ุงููุชุฑุฉ");
            let csv = "\uFEFFุงูุงุณู,ุงูุฑูู ุงููุธููู,ุงููุณู,ุงูุชุงุฑูุฎ,ุงูุณุงุนุงุช,ุงูุณุจุจ\n";
            employees.forEach(emp => (emp.overtime||[]).forEach(o => {
                if(o.date >= s && o.date <= e) csv += `${emp.name},${emp.id},${emp.details['ุงููุณู']},${o.date},${o.hours},${(o.reason||"").replace(/,/g,"-")}\n`;
            }));
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
            link.download = `ุชูุฑูุฑ_ุงูุฅุถุงูู_${s}_ุฅูู_${e}.csv`;
            link.click();
            closeModal('modalExportOvertime');
        }

        function downloadBackup() {
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([JSON.stringify(employees)], {type:"application/json"}));
            link.download = "HR_Backup_Scloud.json";
            link.click();
        }

        async function importBackup(ev) {
            const file = ev.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm("ุณูุชู ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ ุจุงููุงูู. ุงุณุชูุฑุงุฑุ")) {
                        // ุญุฐู ุงูุณุญุงุจุฉ ุฃููุงู (ูู ุงูุจูุฆุฉ ุงูุญููููุฉ ููุถู ูุณุญ ุงููุฌููุนุฉ)
                        alert("ุฌุงุฑู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุณุญุงุจูุงู... ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ุซูุงูู.");
                        for(let emp of data) {
                            delete emp.fsId; // ุญุฐู ุงููุนุฑู ุงููุฏูู ูุชุฌูุจ ุงูุชุนุงุฑุถ
                            await empCol.add(emp);
                        }
                        location.reload();
                    }
                } catch(err) { alert("ููู ุชุงูู"); }
            };
            reader.readAsText(file);
        }

        async function analyzePerformanceAI() {
            const emp = employees.find(e => e.id == currentEmpId);
            openModal('modalAI');
            document.getElementById('aiResContent').innerHTML = "ุฌุงุฑู ุงูุชุญููู ุจุงุณุชุฎุฏุงู Gemini...";
            // ูุญุงูุงุฉ ุงูุงุชุตุงู - ูุชุทูุจ ุฅุถุงูุฉ ููุชุงุญ API ุงูุฎุงุต ุจู ูุชูุนููู ุญููููุงู
            setTimeout(() => {
                document.getElementById('aiResContent').innerHTML = `ุชุญููู ูู ${emp.name}: ุงูููุธู ูุฏูู ${emp.actions.length} ุฅูุฐุงุฑุงุช ู ${emp.tasks.length} ููุงู ููุฌุฒุฉ. ููุตู ุจูุฑุงุฌุนุฉ ุฌูุฏุฉ ุงูููุงู ูู ูุณู ${emp.details['ุงููุณู']} ูุชุญุณูู ุงูุฅูุชุงุฌูุฉ.`;
            }, 1000);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- Boot ---
        window.onload = initApp;

    </script>
</body>
</html>
