<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .hidden-section { display: none; }
        .active { display: block; }
    </style>
</head>
<body>
<!-- ======= HTML CONTENT ======= -->
<!-- Ø§ÙØªØ±Ø¶Øª ÙƒÙ„ HTML Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¹Ø§Ù…Ù„Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡Ù†Ø§ Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ -->

<!-- ======= JS CODE ======= -->
<script>
/* =======================
   GLOBAL STATE
======================= */
let employees = [];
let currentEmpId = null;
let systemDate = new Date(); // Ù…Ø«Ø§Ù„ Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø¸Ø§Ù…
let apiKey = ""; // Ù„Ùˆ Ø±Ø§Ø­ ØªØ³ØªØ¹Ù…Ù„ Gemini API

/* =======================
   NAVIGATION
======================= */
function showSection(id) {
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
    const sec = document.getElementById(id);
    if (sec) sec.classList.remove('hidden-section');

    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
    const link = document.getElementById('link-' + id);
    if (link) link.classList.add('active');

    const titleSpan = document.querySelector(`#link-${id} span`);
    document.getElementById('section-title').innerText = titleSpan ? titleSpan.innerText : '';
}

/* =======================
   MODALS
======================= */
function openModal(id) { const modal = document.getElementById(id); if(modal) modal.classList.add('active'); }
function closeModal(id) { const modal = document.getElementById(id); if(modal) modal.classList.remove('active'); }

/* =======================
   EMPLOYEE FUNCTIONS
======================= */
function saveNewEmployee(e) {
    e.preventDefault();
    const id = document.getElementById('f_id').value;
    if(employees.some(emp => emp.id == id)) return alert("Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„!");
    employees.push({
        id: id,
        name: document.getElementById('f_name').value,
        details: { 
            "Ø§Ù„Ù‚Ø³Ù…": document.getElementById('f_dept').value,
            "Ø§Ù„Ù…Ø³Ù…Ù‰": document.getElementById('f_pos').value,
            "Ø§Ù„Ø±Ø§ØªØ¨": document.getElementById('f_salary').value,
            "Ø§Ù„Ù‡Ø§ØªÙ": document.getElementById('f_phone').value,
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯": document.getElementById('f_dob').value,
            "ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…": document.getElementById('f_blood').value,
            "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†": document.getElementById('f_address').value,
            "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„": document.getElementById('f_start_date').value,
            "Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª": document.getElementById('f_leave_bal').value,
            "Ø§Ù„Ø¬Ù†Ø³ÙŠØ©": document.getElementById('f_nat').value
        },
        schedule: {}, actions: [], tasks: [], leaves: [], overtime: []
    });
    saveToStorage();
    showSection('dashboard');
}

function searchEmployees() {
    const v = document.getElementById('empSearch').value.toLowerCase();
    renderEmployeeList(employees.filter(e => e.name.toLowerCase().includes(v) || e.id.toLowerCase().includes(v)));
}

function renderEmployeeList(data = employees) {
    const tbody = document.getElementById('employeesTableBody');
    if(!tbody) return;
    tbody.innerHTML = data.map(emp => `
        <tr class="hover:bg-slate-50 border-b font-bold">
            <td class="p-5">${emp.name} <span class="text-slate-300">#${emp.id}</span></td>
            <td class="p-5 text-slate-500">${emp.details['Ø§Ù„Ù‚Ø³Ù…']}</td>
            <td class="p-5 text-center">
                <button onclick="viewProfile('${emp.id}')" class="bg-blue-50 text-blue-700 px-8 py-2 rounded-2xl font-black text-xs hover:bg-blue-600 hover:text-white transition-all">Ø¹Ø±Ø¶</button>
            </td>
        </tr>
    `).join('');
}

function updateDashboardStats() {
    document.getElementById('stat-emp-count').innerText = employees.length;
    let a=0, l=0; employees.forEach(e => { a += (e.actions||[]).length; l += (e.leaves||[]).length; });
    document.getElementById('stat-action-count').innerText = a;
    document.getElementById('stat-leave-count').innerText = l;
}

function renderUpcomingBirthdays() {
    const checkDate = new Date(systemDate);
    const list = employees.filter(e => {
        if(!e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']) return false;
        const b = new Date(e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']);
        return b.getMonth() === checkDate.getMonth();
    });
    const container = document.getElementById('birthdayList');
    if(!container) return;
    container.innerHTML = list.map(e => `
        <div class="p-3 bg-slate-50 rounded-xl flex justify-between items-center text-[10px] font-black border border-slate-100">
            <span>${e.name}</span><span class="text-blue-600">${e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']}</span>
        </div>
    `).join('') || '<p class="text-center text-slate-300 italic py-4 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>';
}

function filterEmployeesByStat(type) {
    let filtered = [];
    if(type === 'actions') filtered = employees.filter(e => (e.actions||[]).length > 0);
    else if(type === 'leaves') filtered = employees.filter(e => (e.leaves||[]).length > 0);
    showSection('employees');
    renderEmployeeList(filtered);
}

/* =======================
   BACKUP FUNCTIONS
======================= */
function downloadFullBackup() {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([JSON.stringify(employees)], {type:"application/json"}));
    a.download = "HR_Backup.json";
    a.click();
}

function importFullBackup(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (Array.isArray(importedData)) {
                if (confirm("ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                    employees = importedData;
                    saveToStorage();
                    window.location.reload();
                }
            } else alert("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØµØ§Ù„Ø­.");
        } catch(err) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ù„Ù JSON Ø³Ù„ÙŠÙ….");
            console.error(err);
        }
    };
    reader.readAsText(file);
}

/* =======================
   OVERTIME FUNCTIONS
======================= */
function prepareOvertimeModal() {
    const emp = employees.find(e => e.id == currentEmpId);
    if (!emp.overtime) emp.overtime = [];
    const usedHours = emp.overtime.reduce((sum, item) => sum + parseFloat(item.hours), 0);
    const remaining = 20 - usedHours;

    document.getElementById('overtime_remaining_display').innerText = remaining;
    document.getElementById('overtime_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('overtime_hours').value = "";

    if (remaining <= 0) alert("ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù‚Ø¯ Ø§Ø³ØªÙ†ÙØ° Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (20 Ø³Ø§Ø¹Ø©).");

    openModal('modalOvertime');
}

function saveOvertime() {
    const emp = employees.find(e => e.id == currentEmpId);
    if (!emp.overtime) emp.overtime = [];

    const date = document.getElementById('overtime_date').value;
    const hours = parseFloat(document.getElementById('overtime_hours').value);
    const reason = document.getElementById('overtime_reason').value;

    if (!date || !hours || hours <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©");

    const currentUsed = emp.overtime.reduce((sum, item) => sum + parseFloat(item.hours), 0);
    const newTotal = currentUsed + hours;

    if (newTotal > 20) {
        alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¶Ø§ÙØ©! \nØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUsed} Ø³Ø§Ø¹Ø©.\nØ§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${hours} Ø³Ø§Ø¹Ø©.\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø³ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (20 Ø³Ø§Ø¹Ø©).`);
        return;
    }

    emp.overtime.push({ date, hours, reason });
    saveToStorage();
    viewProfile(currentEmpId);
    closeModal('modalOvertime');
}

function renderOvertimeTable(emp) {
    const tbody = document.getElementById('profileOvertimeTable');
    const records = emp.overtime || [];
    const totalHours = records.reduce((sum, item) => sum + parseFloat(item.hours), 0);
    const remaining = 20 - totalHours;

    document.getElementById('profile-overtime-stats').innerHTML = 
        `Ù…Ø³ØªØ®Ø¯Ù…: <span class="text-red-600">${totalHours}</span> | Ù…ØªØ¨Ù‚ÙŠ: <span class="text-green-600">${remaining}</span>`;

    tbody.innerHTML = records.map((item, index) => `
        <tr class="hover:bg-orange-50 transition">
            <td class="p-3 text-slate-500">${item.date}</td>
            <td class="p-3 text-orange-600 text-lg">${item.hours}</td>
            <td class="p-3 text-slate-700">${item.reason}</td>
            <td class="p-3 text-left">
                <button onclick="deleteOvertime(${index})" class="text-red-400 hover:text-red-600 font-bold transition">âœ•</button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="4" class="p-6 text-center text-slate-300 italic">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø³Ø¬Ù„Ø©</td></tr>';
}

function deleteOvertime(index) {
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù‡Ø°Ø§ØŸ")) {
        const emp = employees.find(e => e.id == currentEmpId);
        emp.overtime.splice(index,1);
        saveToStorage();
        viewProfile(currentEmpId);
    }
}

function downloadOvertimeExcel() {
    const startDateVal = document.getElementById('export_start_date').value;
    const endDateVal = document.getElementById('export_end_date').value;

    if(!startDateVal || !endDateVal) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø© (Ù…Ù† - Ø¥Ù„Ù‰) Ø£ÙˆÙ„Ø§Ù‹");
    if(new Date(startDateVal) > new Date(endDateVal)) return alert("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");

    let csvContent = "\uFEFF"; 
    csvContent += "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„,Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ,Ø§Ù„Ù‚Ø³Ù…,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª,Ø§Ù„Ø³Ø¨Ø¨\n";

    let totalHoursAll=0, recordsFound=0;

    employees.forEach(emp=>{
        if(emp.overtime && emp.overtime.length>0){
            emp.overtime.forEach(record=>{
                if(record.date >= startDateVal && record.date <= endDateVal){
                    const cleanReason = (record.reason||"").replace(/,/g," - ");
                    const row=[emp.name, emp.id, emp.details['Ø§Ù„Ù‚Ø³Ù…']||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯", record.date, record.hours, cleanReason].join(",");
                    csvContent += row + "\n";
                    totalHoursAll += parseFloat(record.hours);
                    recordsFound++;
                }
            });
        }
    });

    if(recordsFound===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.");

    csvContent += `\n,,,Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ,${totalHoursAll} Ø³Ø§Ø¹Ø©,`;

    const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
    const link=document.createElement("a");
    const url=URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø§Ø¶Ø§ÙÙŠ_${startDateVal}_Ø§Ù„Ù‰_${endDateVal}.csv`);
    link.style.visibility='hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    closeModal('modalExportOvertime');
}

/* =======================
   AI FUNCTIONS
======================= */
async function callGemini(prompt){
    if(!apiKey) throw new Error("API Key Missing");
    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method:'POST',
        body: JSON.stringify({ contents: [{ parts:[{ text: prompt }] }] })
    });
    const res = await r.json();
    return res.candidates[0].content.parts[0].text;
}

async function analyzePerformanceWithAI(){
    const emp=employees.find(e=>e.id==currentEmpId);
    openModal('modalAI');
    document.getElementById('aiResultContent').innerHTML=`<p class="animate-pulse text-xs">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>`;
    try{
        const r = await callGemini(`Ø­Ù„Ù„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù: ${emp.name}.`);
        document.getElementById('aiResultContent').innerHTML=`<div class="prose font-bold text-[10px] leading-relaxed text-slate-700">${r.replace(/\n,'<br>')}</div>`;
    } catch(e){
        document.getElementById('aiResultContent').innerHTML=`<p class="text-red-500 font-bold">ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ API.</p>`;
    }
}

/* =======================
   UTILITY FUNCTIONS
======================= */
function calculateWorkDuration() {
    const startDateVal = document.getElementById('f_start_date').value;
    const resultDisplay = document.getElementById('duration_result');
    if(!startDateVal) return;
    const startDate = new Date(startDateVal);
    const today = new Date(systemDate);
    if(startDate>today){ resultDisplay.innerText="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ!"; resultDisplay.style.color="red"; return; }
    let years = today.getFullYear()-startDate.getFullYear();
    let months = today.getMonth()-startDate.getMonth();
    let days = today.getDate()-startDate.getDate();
    if(days<0){ months--; days+=new Date(today.getFullYear(),today.getMonth(),0).getDate(); }
    if(months<0){ years--; months+=12; }
    resultDisplay.style.color="#1e40af";
    resultDisplay.innerText=`${years} Ø³Ù†Ø© Ùˆ ${months} Ø´Ù‡Ø± Ùˆ ${days} ÙŠÙˆÙ…`;
}

function getDatesInRange(startDate,endDate){
    const dates=[]; let currentDate=new Date(startDate); const end=new Date(endDate);
    while(currentDate<=end){ dates.push(currentDate.toISOString().split('T')[0]); currentDate.setDate(currentDate.getDate()+1); }
    return dates;
}

function calculateDaysDiff(start,end){
    const date1=new Date(start);
    const date2=new Date(end);
    const diffTime=Math.abs(date2-date1);
    const diffDays=Math.ceil(diffTime/(1000*60*60*24))+1;
    return diffDays;
}

/* =======================
   ONLOAD
======================= */
window.onload = ()=>{
    updateSystemDateUI?.();
    showSection('dashboard');
};
</script>

<!-- =======================
     FIREBASE SDK
======================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

const firebaseConfig = {
  apiKey: "AIzaSyAAe-WjGh9PtL932wxJPgLSuaslmJWaDC8",
  authDomain: "hr-operation.firebaseapp.com",
  databaseURL: "https://hr-operation-default-rtdb.firebaseio.com",
  projectId: "hr-operation",
  storageBucket: "hr-operation.firebasestorage.app",
  messagingSenderId: "498775599728",
  appId: "1:498775599728:web:b195dea758f3cf415162b5",
  measurementId: "G-YQTYHQ40NN"
};

const app = initializeApp(firebaseConfig);
console.log("ğŸ”¥ Firebase Connected", app);
</script>
</body>
</html>
