<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Cloud System v19.5 - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .hidden-section { display: none; }
        .modal { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .sidebar-link { cursor: pointer; transition: 0.3s; }
        .sidebar-link.active { background: #2563eb; color: white; border-radius: 12px; }
        input, select, textarea { border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="flex min-h-screen text-slate-800">

    <aside class="w-64 bg-slate-900 text-slate-300 p-6 flex-shrink-0 flex flex-col no-print">
        <h1 class="text-xl font-black text-white mb-8 text-center">HR PLATFORM โจ</h1>
        <nav class="space-y-4 flex-1">
            <div onclick="showSection('dashboard')" id="link-dashboard" class="sidebar-link p-3 active font-bold">๐ ููุญุฉ ุงูุชุญูู</div>
            <div onclick="showSection('employees')" id="link-employees" class="sidebar-link p-3 font-bold">๐ฅ ุฅุฏุงุฑุฉ ุงูููุธููู</div>
        </nav>
        <div class="border-t border-slate-700 pt-4">
            <button onclick="downloadBackup()" class="w-full text-[10px] bg-slate-800 p-2 rounded mb-2">๐พ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
            <button onclick="openModal('modalExportOvertime')" class="w-full text-[10px] bg-orange-900/50 p-2 rounded text-orange-200">๐ ุชูุฑูุฑ ุงูุฅุถุงูู</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white border-b p-4 flex justify-between items-center no-print">
            <div id="current-date-display" class="font-bold text-blue-600 text-sm"></div>
            <div class="flex gap-4 items-center">
                <input type="date" id="systemDateSelector" onchange="updateSystemDate()" class="text-xs w-40 mt-0">
                <button onclick="showSection('add-employee-form')" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">+ ููุธู ุฌุฏูุฏ</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 space-y-8">
            
            <section id="dashboard" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center">
                        <p class="text-xs text-slate-400 font-bold uppercase">ุงูููุธููู</p>
                        <h2 id="stat-count" class="text-3xl font-black">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center">
                        <p class="text-xs text-red-400 font-bold uppercase">ุงูุฅูุฐุงุฑุงุช</p>
                        <h2 id="stat-actions" class="text-3xl font-black text-red-600">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center text-emerald-600">
                        <p class="text-xs text-emerald-400 font-bold uppercase">ุงูุฅุฌุงุฒุงุช</p>
                        <h2 id="stat-leaves" class="text-3xl font-black">0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center text-blue-600">
                        <p class="text-xs text-blue-400 font-bold uppercase">ุงูููุงู</p>
                        <h2 id="stat-tasks" class="text-3xl font-black">0</h2>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div class="p-4 bg-slate-50 font-black border-b">๐๏ธ ุฎุฑูุทุฉ ุงูุฏูุงู ุงูุฃุณุจูุนู</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right text-xs">
                            <thead class="bg-slate-100 uppercase"><tr id="dash-head"></tr></thead>
                            <tbody id="dash-body" class="divide-y font-bold"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl border shadow-sm">
                        <div class="p-4 bg-blue-600 text-white font-bold">๐ ุฃุนูุงุฏ ูููุงุฏ ุงูุดูุฑ</div>
                        <div id="birthdays-list" class="p-4 space-y-2"></div>
                    </div>
                    <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                        <div class="p-4 bg-red-50 text-red-700 font-bold border-b">๐ ุชุนุงุฑุถุงุช ุงูุฅุฌุงุฒุงุช</div>
                        <div id="conflicts-list" class="p-4 text-xs font-bold space-y-1"></div>
                    </div>
                </div>
            </section>

            <section id="employees" class="hidden-section space-y-4">
                <input type="text" id="empSearch" onkeyup="searchEmps()" placeholder="ุงุจุญุซ ุจุงุณู ุงูููุธู ุฃู ุงููุณู..." class="shadow-sm">
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-slate-50 font-black"><tr><th class="p-4">ุงูุงุณู</th><th class="p-4">ุงููุณู</th><th class="p-4 text-center">ุงูุฅุฌุฑุงุก</th></tr></thead>
                        <tbody id="employees-table-body" class="divide-y font-bold"></tbody>
                    </table>
                </div>
            </section>

            <section id="add-employee-form" class="hidden-section max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-3xl border shadow-xl">
                    <h2 class="text-2xl font-black text-blue-800 mb-6">ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ</h2>
                    <form onsubmit="handleNewEmployee(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 font-bold text-xs">
                            <div><label>ุงูุงุณู ุงููุงูู</label><input type="text" id="f_name" required></div>
                            <div><label>ุงูุฑูู ุงููุธููู</label><input type="text" id="f_id" required></div>
                            <div><label>ุชุงุฑูุฎ ุงููููุงุฏ</label><input type="date" id="f_dob"></div>
                            <div><label>ุงููุณู</label><input type="text" id="f_dept"></div>
                            <div><label>ุงููุณูู ุงููุธููู</label><input type="text" id="f_pos"></div>
                            <div><label>ุชุงุฑูุฎ ุจุฏุก ุงูุนูู</label><input type="date" id="f_start" onchange="calcDurationForm()"></div>
                            <div class="md:col-span-2"><label>ูุฏุฉ ุงูุฎุฏูุฉ (ุชููุงุฆู)</label><div id="f_dur" class="p-3 bg-blue-50 rounded-xl text-blue-700 h-[45px] flex items-center mt-1">--</div></div>
                            <div><label>ุงููุฑุชุจ</label><input type="number" id="f_salary"></div>
                            <div><label>ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช</label><input type="number" id="f_leave" value="30"></div>
                            <div><label>ุงููุงุชู</label><input type="tel" id="f_phone"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg">ุญูุธ ุงูููุธู ุณุญุงุจูุงู</button>
                    </form>
                </div>
            </section>

            <section id="employee-profile" class="hidden-section space-y-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button onclick="showSection('employees')" class="bg-white p-3 rounded-xl border">โฌ๏ธ</button>
                        <div><h2 id="p-name" class="text-2xl font-black">--</h2><p id="p-job" class="text-blue-600 font-bold text-xs">--</p></div>
                    </div>
                    <div class="flex flex-wrap gap-2 no-print">
                        <button onclick="openModal('modalSchedule')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold">๐ ุงูุฏูุงู</button>
                        <button onclick="openModal('modalAction')" class="bg-red-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold">โ๏ธ ุฅูุฐุงุฑ</button>
                        <button onclick="openModal('modalTask')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold">๐ ูููุฉ</button>
                        <button onclick="prepareOvertimeModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-[10px] font-bold">โณ ุฅุถุงูู</button>
                        <button onclick="openModal('modalLeave')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold">๐ด ุฅุฌุงุฒุฉ</button>
                        <button onclick="deleteEmpProfile()" class="bg-red-50 text-red-600 p-2 rounded-lg text-[10px] border border-red-100">๐๏ธ ุญุฐู</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl border text-center shadow-sm">
                            <div class="w-16 h-16 bg-blue-100 rounded-full mx-auto flex items-center justify-center text-2xl font-black text-blue-600 mb-2" id="p-avatar">?</div>
                            <div class="flex justify-around border-t pt-4 text-[10px] font-bold">
                                <div><p class="text-slate-400 uppercase">ุงูุฅูุฐุงุฑุงุช</p><p id="p-stat-act" class="text-red-600 text-lg">0</p></div>
                                <div><p class="text-slate-400 uppercase">ุงูุฅุฌุงุฒุงุช</p><p id="p-stat-leave" class="text-emerald-600 text-lg">0</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border shadow-sm">
                            <h4 class="font-bold text-xs mb-4 border-b pb-2">๐ ุงูุฏูุงู ุงูุฃุณุจูุนู</h4>
                            <div id="p-schedule-list" class="space-y-2 text-[10px] font-bold"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border shadow-sm h-fit">
                        <h4 class="font-bold text-xs mb-4 border-b pb-2">๐ ุงููุนูููุงุช ุงูุดุฎุตูุฉ</h4>
                        <div id="p-info-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-xs font-bold"></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border overflow-hidden no-print">
                    <div class="p-3 bg-slate-900 text-white font-bold text-xs flex justify-between">
                        <span>๐ ุณุฌู ุชูููู ุงูููุงู</span>
                        <select id="task-filter" onchange="renderTaskTable()" class="bg-slate-800 text-white p-0 text-[10px] border-none w-auto h-6">
                            <option value="ุงููู">ุงููู</option>
                            <option value="ุนูููุงุช">ุนูููุงุช</option>
                            <option value="ูุชุงุจุนุฉ">ูุชุงุจุนุฉ</option>
                            <option value="ุงูููุงููุงุช">ุงูููุงููุงุช</option>
                        </select>
                    </div>
                    <table class="w-full text-right text-[10px]"><thead class="bg-slate-50 font-bold border-b"><tr><th class="p-3">ุงูุชุงุฑูุฎ</th><th class="p-3">ุงููููุฉ</th><th class="p-3">ุฌูุฏุฉ%</th><th class="p-3">ุงูุนุฏุฏ</th></tr></thead><tbody id="p-task-body" class="divide-y font-bold"></tbody></table>
                </div>
            </section>
        </div>
    </main>

    <div id="modalLeave" class="modal"><div class="bg-white p-8 rounded-3xl w-full max-w-md"><h3>ุฅุฌุงุฒุฉ ุฌุฏูุฏุฉ</h3><div class="grid grid-cols-2 gap-2 mt-4"><input type="date" id="l_from"><input type="date" id="l_to"></div><select id="l_type" class="mt-2"><option>ุณูููุฉ</option><option>ูุฑุถูุฉ</option><option>ุทุงุฑุฆุฉ</option></select><textarea id="l_reason" placeholder="ุงูุณุจุจ" class="mt-2"></textarea><button onclick="saveLeave()" class="w-full bg-emerald-600 text-white py-3 rounded-xl mt-4 font-bold">ุญูุธ</button><button onclick="closeModal('modalLeave')" class="w-full mt-2 text-slate-400">ุฅูุบุงุก</button></div></div>
    <div id="modalAction" class="modal"><div class="bg-white p-8 rounded-3xl w-full max-w-md"><h3>ุชุณุฌูู ุฅูุฐุงุฑ</h3><select id="a_type" class="mt-4"><option>ุชุฃุฎูุฑ</option><option>ูุชุงุจู</option></select><input type="date" id="a_date" class="mt-2"><textarea id="a_reason" placeholder="ุงูุชูุงุตูู" class="mt-2"></textarea><button onclick="saveAction()" class="w-full bg-red-600 text-white py-3 rounded-xl mt-4 font-bold">ุญูุธ</button><button onclick="closeModal('modalAction')" class="w-full mt-2 text-slate-400">ุฅูุบุงุก</button></div></div>
    <div id="modalTask" class="modal"><div class="bg-white p-8 rounded-3xl w-full max-w-md"><h3>ุชูููู ูููุฉ</h3><select id="t_type" class="mt-4"><option>ุนูููุงุช</option><option>ูุชุงุจุนุฉ</option><option>ุงูููุงููุงุช</option></select><input type="number" id="t_qual" placeholder="ุงูุฌูุฏุฉ%" class="mt-2"><input type="number" id="t_count" placeholder="ุงูุนุฏุฏ" class="mt-2"><input type="date" id="t_date" class="mt-2"><button onclick="saveTask()" class="w-full bg-blue-600 text-white py-3 rounded-xl mt-4 font-bold">ุญูุธ</button><button onclick="closeModal('modalTask')" class="w-full mt-2 text-slate-400">ุฅูุบุงุก</button></div></div>
    <div id="modalSchedule" class="modal"><div class="bg-white p-8 rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"><h3>ุงูุฌุฏูู ุงูุฃุณุจูุนู</h3><div id="schedule-inputs" class="space-y-2 mt-4"></div><button onclick="saveSchedule()" class="w-full bg-indigo-600 text-white py-3 rounded-xl mt-4 font-bold">ุญูุธ ุงูุฌุฏูู</button><button onclick="closeModal('modalSchedule')" class="w-full mt-2 text-slate-400">ุฅูุบุงุก</button></div></div>
    <div id="modalOvertime" class="modal"><div class="bg-white p-8 rounded-3xl w-full max-w-md"><h3>ุชุณุฌูู ุฅุถุงูู</h3><div id="over-rem-txt" class="p-2 bg-orange-50 text-orange-700 text-center rounded text-xs mb-4">ุงูุฑุตูุฏ ุงููุชุจูู: 20 ุณุงุนุฉ</div><input type="date" id="o_date"><input type="number" id="o_hrs" placeholder="ุนุฏุฏ ุงูุณุงุนุงุช" class="mt-2"><select id="o_reason" class="mt-2"><option>ุถุบุท ุนูู</option><option>ููุต ุฅุฐู</option></select><button onclick="saveOvertime()" class="w-full bg-orange-500 text-white py-3 rounded-xl mt-4 font-bold">ุญูุธ</button><button onclick="closeModal('modalOvertime')" class="w-full mt-2 text-slate-400">ุฅูุบุงุก</button></div></div>

    <script>
        // --- 1. Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAe-WjGh9PtL932wxJPgLSuaslmJWaDC8",
            authDomain: "hr-operation.firebaseapp.com",
            projectId: "hr-operation",
            storageBucket: "hr-operation.firebasestorage.app",
            messagingSenderId: "498775599728",
            appId: "1:498775599728:web:b195dea758f3cf415162b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const empCol = db.collection('employees');

        // --- 2. State & Constants ---
        let emps = [];
        let curId = null;
        let sysDate = new Date();
        const weekDays = ["ุงูุณุจุช", "ุงูุฃุญุฏ", "ุงูุงุซููู", "ุงูุซูุงุซุงุก", "ุงูุฃุฑุจุนุงุก", "ุงูุฎููุณ", "ุงูุฌูุนุฉ"];

        // --- 3. Core Logic ---
        function initApp() {
            empCol.onSnapshot(snap => {
                emps = snap.docs.map(doc => ({ fsId: doc.id, ...doc.data() }));
                refreshUI();
            });
            updateDateUI();
        }

        function refreshUI() {
            // Stats
            document.getElementById('stat-count').innerText = emps.length;
            let a=0, l=0, t=0;
            emps.forEach(e => { a+=(e.actions||[]).length; l+=(e.leaves||[]).length; t+=(e.tasks||[]).length; });
            document.getElementById('stat-actions').innerText = a;
            document.getElementById('stat-leaves').innerText = l;
            document.getElementById('stat-tasks').innerText = t;

            if (!document.getElementById('employees').classList.contains('hidden-section')) renderEmpList();
            if (!document.getElementById('dashboard').classList.contains('hidden-section')) renderDashboard();
            if (curId) renderProfile(emps.find(e => e.id == curId));
        }

        // Navigation
        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            if(document.getElementById('link-'+id)) document.getElementById('link-'+id).classList.add('active');
            refreshUI();
        }

        // --- 4. Employee Functions ---
        async function handleNewEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('f_id').value;
            if(emps.some(x => x.id == id)) return alert("ุงูุฑูู ุงููุธููู ููุฌูุฏ!");

            const newObj = {
                id: id,
                name: document.getElementById('f_name').value,
                details: {
                    "ุงููุณู": document.getElementById('f_dept').value,
                    "ุงููุณูู": document.getElementById('f_pos').value,
                    "ุจุฏุงูุฉ ุงูุนูู": document.getElementById('f_start').value,
                    "ุชุงุฑูุฎ ุงููููุงุฏ": document.getElementById('f_dob').value,
                    "ุงููุฑุชุจ": document.getElementById('f_salary').value,
                    "ุงููุงุชู": document.getElementById('f_phone').value,
                    "ุฑุตูุฏ ุงูุฅุฌุงุฒุงุช": document.getElementById('f_leave').value
                },
                schedule: {}, actions: [], tasks: [], leaves: [], overtime: []
            };

            await empCol.add(newObj);
            alert("ุชู ุงูุญูุธ ุณุญุงุจูุงู โ");
            showSection('dashboard');
        }

        function renderEmpList() {
            document.getElementById('employees-table-body').innerHTML = emps.map(e => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-4">${e.name} <span class="text-slate-300">#${e.id}</span></td>
                    <td class="p-4 text-slate-500">${e.details['ุงููุณู']}</td>
                    <td class="p-4 text-center">
                        <button onclick="viewEmp('${e.id}')" class="bg-blue-600 text-white px-6 py-1 rounded-lg text-xs">ุนุฑุถ ุงูููู</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewEmp(id) {
            curId = id;
            const emp = emps.find(e => e.id == id);
            renderProfile(emp);
            showSection('employee-profile');
        }

        function renderProfile(emp) {
            if(!emp) return;
            document.getElementById('p-name').innerText = emp.name;
            document.getElementById('p-job').innerText = emp.details['ุงููุณูู'];
            document.getElementById('p-avatar').innerText = emp.name[0];
            document.getElementById('p-stat-act').innerText = (emp.actions||[]).length;
            document.getElementById('p-stat-leave').innerText = (emp.leaves||[]).length;

            // Details
            let info = Object.entries(emp.details).map(([k,v]) => `
                <div class="bg-slate-50 p-3 rounded-xl border">
                    <p class="text-[9px] text-slate-400 uppercase">${k}</p>
                    <p>${v || '-'}</p>
                </div>
            `).join('');
            info += `<div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-blue-800"><p class="text-[9px] uppercase">ูุฏุฉ ุงูุฎุฏูุฉ</p><p>${calcDuration(emp.details['ุจุฏุงูุฉ ุงูุนูู'])}</p></div>`;
            document.getElementById('p-info-grid').innerHTML = info;

            // Schedule
            document.getElementById('p-schedule-list').innerHTML = weekDays.map(d => {
                const s = emp.schedule[d] || {type:'ุนูู', from:'08:00', to:'16:00'};
                return `<div class="flex justify-between p-2 border rounded-lg ${s.type==='ุนุทูุฉ'?'bg-red-50 text-red-600':'bg-slate-50'}"><span>${d}</span><span>${s.type==='ุนุทูุฉ'?'ุฑุงุญุฉ':s.from+' - '+s.to}</span></div>`;
            }).join('');

            renderTaskTable();
        }

        function renderTaskTable() {
            const emp = emps.find(e => e.id == curId);
            const filter = document.getElementById('task-filter').value;
            let tasks = emp.tasks || [];
            if(filter !== 'ุงููู') tasks = tasks.filter(t => t.type === filter);
            document.getElementById('p-task-body').innerHTML = tasks.map(t => `<tr class="border-b"><td class="p-3">${t.date}</td><td class="p-3">${t.type}</td><td class="p-3 font-black text-blue-600">${t.quality}%</td><td class="p-3">${t.count}</td></tr>`).join('') || '<tr><td colspan="4" class="p-4 text-center text-slate-300">ูุง ููุฌุฏ ุจูุงูุงุช</td></tr>';
        }

        // --- 5. Dashboard Rendering ---
        function renderDashboard() {
            const head = `<th class="p-3 border-l">ุงูููุธู</th>` + weekDays.map(d => `<th class="p-3 text-center">${d}</th>`).join('');
            document.getElementById('dash-head').innerHTML = head;

            document.getElementById('dash-body').innerHTML = emps.map(e => `
                <tr class="border-b">
                    <td class="p-3 bg-slate-50 sticky right-0 font-black">${e.name}</td>
                    ${weekDays.map(d => {
                        const s = e.schedule[d] || {from:'08:00'};
                        return `<td class="p-3 text-center text-blue-600">${s.from}</td>`;
                    }).join('')}
                </tr>
            `).join('');

            // Birthdays
            const month = new Date(sysDate).getMonth();
            const births = emps.filter(e => e.details['ุชุงุฑูุฎ ุงููููุงุฏ'] && new Date(e.details['ุชุงุฑูุฎ ุงููููุงุฏ']).getMonth() === month);
            document.getElementById('birthdays-list').innerHTML = births.map(e => `<div class="p-2 bg-slate-50 rounded border text-xs font-bold flex justify-between"><span>${e.name}</span><span class="text-blue-600">${e.details['ุชุงุฑูุฎ ุงููููุงุฏ']}</span></div>`).join('') || '<p class="text-xs italic text-slate-300">ูุง ููุฌุฏ ุฃุนูุงุฏ ูููุงุฏ</p>';
        }

        // --- 6. Helper & UI Functions ---
        function calcDuration(startStr) {
            if(!startStr) return "--";
            const s = new Date(startStr);
            const t = new Date(sysDate);
            let y = t.getFullYear() - s.getFullYear();
            let m = t.getMonth() - s.getMonth();
            if(m < 0) { y--; m += 12; }
            return `${y} ุณูุฉ ู ${m} ุดูุฑ`;
        }

        function calcDurationForm() {
            document.getElementById('f_dur').innerText = calcDuration(document.getElementById('f_start').value);
        }

        function updateDateUI() {
            document.getElementById('current-date-display').innerText = sysDate.toLocaleDateString('ar-EG', { weekday:'long', day:'numeric', month:'long' });
            document.getElementById('systemDateSelector').value = sysDate.toISOString().split('T')[0];
        }

        function updateSystemDate() {
            sysDate = new Date(document.getElementById('systemDateSelector').value);
            updateDateUI();
            refreshUI();
        }

        // Modal Helpers
        function openModal(id) { 
            if(id === 'modalSchedule') prepareScheduleModal(); 
            if(id === 'modalOvertime') prepareOvertimeModal();
            document.getElementById(id).classList.add('active'); 
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- 7. Saving Sub-data ---
        async function saveLeave() {
            const emp = emps.find(e => e.id == curId);
            emp.leaves.push({ from: document.getElementById('l_from').value, to: document.getElementById('l_to').value, type: document.getElementById('l_type').value, reason: document.getElementById('l_reason').value });
            await empCol.doc(emp.fsId).update({ leaves: emp.leaves });
            closeModal('modalLeave');
        }

        async function saveAction() {
            const emp = emps.find(e => e.id == curId);
            emp.actions.push({ type: document.getElementById('a_type').value, date: document.getElementById('a_date').value, reason: document.getElementById('a_reason').value });
            await empCol.doc(emp.fsId).update({ actions: emp.actions });
            closeModal('modalAction');
        }

        async function saveTask() {
            const emp = emps.find(e => e.id == curId);
            emp.tasks.push({ type: document.getElementById('t_type').value, date: document.getElementById('t_date').value, quality: document.getElementById('t_qual').value, count: document.getElementById('t_count').value });
            await empCol.doc(emp.fsId).update({ tasks: emp.tasks });
            closeModal('modalTask');
        }

        function prepareScheduleModal() {
            const emp = emps.find(e => e.id == curId);
            document.getElementById('schedule-inputs').innerHTML = weekDays.map(d => {
                const s = emp.schedule[d] || {type:'ุนูู', from:'08:00', to:'16:00'};
                return `<div class="grid grid-cols-4 gap-2 items-center text-xs font-bold border-b pb-2"><span>${d}</span><select id="s-type-${d}"><option value="ุนูู" ${s.type==='ุนูู'?'selected':''}>ุนูู</option><option value="ุนุทูุฉ" ${s.type==='ุนุทูุฉ'?'selected':''}>ุฑุงุญุฉ</option></select><input type="time" id="s-from-${d}" value="${s.from}"><input type="time" id="s-to-${d}" value="${s.to}"></div>`;
            }).join('');
        }

        async function saveSchedule() {
            const emp = emps.find(e => e.id == curId);
            weekDays.forEach(d => {
                emp.schedule[d] = { type: document.getElementById('s-type-'+d).value, from: document.getElementById('s-from-'+d).value, to: document.getElementById('s-to-'+d).value };
            });
            await empCol.doc(emp.fsId).update({ schedule: emp.schedule });
            closeModal('modalSchedule');
        }

        // --- Start App ---
        window.onload = initApp;

    </script>
</body>
</html>
