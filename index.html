<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… HR Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - v20.0 (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --accent: #facc15; --bg-main: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-main); color: #1e293b; }
        .sidebar-link { transition: all 0.3s ease; cursor: pointer; }
        .sidebar-link.active { background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%); border-left: 4px solid var(--accent); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .hidden-section { display: none; }
        .stat-card { transition: all 0.3s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); }
        .modern-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        input, select, textarea { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.6rem 1rem; width: 100%; background-color: #fff; margin-bottom: 0.5rem; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .modal { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal.active { display: flex; }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); }
        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); } 70% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; } }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-72 bg-slate-900 text-white flex-shrink-0 hidden lg:flex flex-col shadow-2xl z-50 no-print">
        <div class="p-8">
            <div class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-400">HR PLATFORM âœ¨</div>
            <p class="text-slate-500 text-[10px] mt-1 font-bold uppercase tracking-widest">Ø¥ØµØ¯Ø§Ø± 20.0 Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <div onclick="showSection('dashboard')" id="link-dashboard" class="sidebar-link flex items-center p-3 rounded-xl hover:bg-slate-800 transition active"><span class="ml-3 font-bold">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></div>
            <div onclick="showSection('employees')" id="link-employees" class="sidebar-link flex items-center p-3 rounded-xl hover:bg-slate-800 transition"><span class="ml-3 font-bold">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></div>
            
            <div class="pt-10 px-3 space-y-2">
                <button onclick="downloadFullBackup()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs py-3 rounded-xl border border-slate-700 font-bold transition-all">ğŸ’¾ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <button onclick="document.getElementById('importFile').click()" class="w-full bg-emerald-900/50 hover:bg-emerald-800 text-emerald-200 text-xs py-3 rounded-xl border border-emerald-700 font-bold transition-all">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importFullBackup(event)">
                <button onclick="openModal('modalExportOvertime')" class="w-full bg-orange-800/50 hover:bg-orange-700 text-orange-100 text-xs py-3 rounded-xl border border-orange-700 font-bold transition-all">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</button>
            </div>
        </nav>
        <div class="p-6 border-t border-slate-800">
            <div class="flex items-center gap-3 bg-slate-800/50 p-4 rounded-2xl">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center font-bold">M</div>
                <div><p class="text-sm font-bold text-white">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</p><p class="text-[10px] text-slate-400" id="current-date-display"></p></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="glass-header shadow-sm p-4 flex justify-between items-center z-40 sticky top-0 border-b border-slate-100 no-print">
            <h2 id="section-title" class="text-xl font-extrabold text-slate-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-end">
                    <span class="text-[9px] font-bold text-blue-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                    <input type="date" id="systemDateSelector" onchange="updateSystemDate()" class="bg-slate-50 border-slate-200 text-xs py-1.5 w-40">
                </div>
                <button onclick="showSection('add-employee-form')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg transition-all">+ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 print-area">
            
            <section id="dashboard" class="space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 no-print">
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-slate-400 font-bold text-[10px] uppercase">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p><h3 class="text-3xl font-black text-slate-800 mt-1" id="stat-emp-count">0</h3></div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-red-400 font-bold text-[10px] uppercase">Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p><h3 class="text-3xl font-black text-red-600 mt-1" id="stat-action-count">0</h3></div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-emerald-400 font-bold text-[10px] uppercase">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</p><h3 class="text-3xl font-black text-emerald-600 mt-1" id="stat-leave-count">0</h3></div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center"><p class="text-blue-400 font-bold text-[10px] uppercase">Ø§Ù„Ù…Ù‡Ø§Ù…</p><h3 class="text-3xl font-black text-blue-600 mt-1" id="stat-task-count">0</h3></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <div class="lg:col-span-3 bg-white rounded-[2.5rem] border border-slate-100 modern-shadow overflow-hidden">
                        <div class="p-8 border-b bg-slate-50/30 font-black text-slate-800 flex justify-between"><span>ğŸ—“ï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</span><span class="text-[10px] text-slate-400" id="week-date-range"></span></div>
                        <div class="overflow-x-auto"><table class="w-full text-right border-collapse whitespace-nowrap"><thead class="bg-slate-50 text-[10px] uppercase"><tr id="dashboardScheduleHeadRow"></tr></thead><tbody id="dashboardScheduleTable" class="text-[11px] font-bold divide-y divide-slate-100"></tbody></table></div>
                    </div>
                    <div class="bg-white rounded-[2.5rem] border border-slate-100 modern-shadow overflow-hidden h-fit no-print">
                        <div class="p-6 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-black">ğŸ‚ Ø£Ø¹ÙŠØ§Ø¯ Ù…ÙŠÙ„Ø§Ø¯ Ù‚Ø§Ø¯Ù…Ø©</div>
                        <div id="birthdayList" class="p-6 space-y-4"></div>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border border-slate-100 modern-shadow overflow-hidden">
                    <div class="p-8 border-b bg-slate-50/30 font-black text-slate-800 flex justify-between"><span>ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠ</span><span class="text-[10px] bg-red-100 text-red-600 px-3 py-1 rounded-full">ÙƒØ§Ø´Ù Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</span></div>
                    <div class="overflow-x-auto max-h-[400px]"><table class="w-full text-right border-collapse"><thead class="bg-slate-50 text-[10px] uppercase sticky top-0 z-10"><tr><th class="p-4 border-b">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</th><th class="p-4 border-b">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ø¬Ø²ÙŠÙ†</th><th class="p-4 border-b text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="yearlyLeavesTable" class="divide-y divide-slate-100 text-xs font-bold"></tbody></table></div>
                </div>
            </section>

            <section id="employees" class="hidden-section space-y-6 font-bold">
                <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-4"><input type="text" id="empSearch" onkeyup="searchEmployees()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù…..." class="bg-slate-50 border-none flex-1"></div>
                <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden"><table class="w-full text-right border-collapse"><thead class="bg-slate-50 text-slate-500 text-xs font-black uppercase tracking-wider"><tr><th class="p-5 border-b">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th><th class="p-5 border-b">Ø§Ù„Ù‚Ø³Ù…</th><th class="p-5 border-b text-center">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead><tbody id="employeesTableBody" class="divide-y divide-slate-100"></tbody></table></div>
            </section>

            <section id="add-employee-form" class="hidden-section max-w-5xl mx-auto no-print">
                <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-xl">
                    <h2 class="text-3xl font-black text-blue-800 mb-8 flex items-center gap-3"><span>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</span><button onclick="showSection('dashboard')" class="text-xs bg-slate-100 px-3 py-1 rounded-lg text-slate-500">Ø±Ø¬ÙˆØ¹</button></h2>
                    <form id="fullEmployeeForm" onsubmit="saveNewEmployee(event)" class="space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="f_name" required></div>
                            <div><label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input type="text" id="f_id" required></div>
                            <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="f_dob"></div>
                            <div><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone"></div>
                            <div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="f_address"></div>
                            <div><label>Ø§Ù„Ù‚Ø³Ù…</label><input type="text" id="f_dept"></div>
                            <div><label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input type="text" id="f_pos"></div>
                            <div><label>Ø§Ù„Ù…Ø±ØªØ¨</label><input type="number" id="f_salary"></div>
                            <div><label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„</label><input type="date" id="f_start_date" onchange="calculateWorkDuration()"></div>
                            <div class="md:col-span-2"><label class="text-blue-600 font-black">Ù…Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label><div id="duration_result" class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-blue-800 text-sm font-bold h-[45px] flex items-center">--</div></div>
                            <div><label>Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</label><input type="number" id="f_leave_bal" value="30"></div>
                            <div><label>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</label><input type="text" id="f_blood"></div>
                            <div><label>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label><input type="text" id="f_nat"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black text-xl shadow-lg">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                    </form>
                </div>
            </section>

            <section id="employee-profile" class="hidden-section space-y-8 pb-10">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-5">
                        <button onclick="showSection('employees')" class="w-14 h-14 bg-white rounded-3xl shadow-sm flex items-center justify-center text-slate-400 font-black text-xl no-print">â¬…ï¸</button>
                        <div><h2 class="text-3xl font-black text-slate-800" id="profile-name-header">--</h2><p class="text-blue-600 font-black text-sm" id="profile-job-header">--</p></div>
                    </div>
                    <div class="flex flex-wrap gap-2 no-print">
                        <button onclick="window.print()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button onclick="analyzePerformanceWithAI()" class="bg-purple-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg ai-pulse">âœ¨ AI</button>
                        <button id="btn-edit-toggle" onclick="toggleEditProfile()" class="bg-slate-500 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button id="btn-save-changes" onclick="saveProfileChanges()" class="hidden bg-emerald-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md">ğŸ’¾ Ø­ÙØ¸</button>
                        <button onclick="openModal('modalSchedule')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md">ğŸ•’ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
                        <button onclick="openModal('modalAction')" class="bg-red-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md">âš ï¸ Ø¥Ù†Ø°Ø§Ø±</button>
                        <button onclick="openModal('modalTask')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md">ğŸ“‹ Ù…Ù‡Ù…Ø©</button>
                        <button onclick="prepareOvertimeModal()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md">â³ Ø¥Ø¶Ø§ÙÙŠ</button>
                        <button onclick="openModal('modalLeave')" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-md">ğŸŒ´ Ø¥Ø¬Ø§Ø²Ø©</button>
                        <button onclick="deleteEmployeeProfile()" class="bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-red-600 hover:text-white transition-all shadow-sm">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 font-bold">
                    <div class="lg:col-span-4 space-y-8">
                        <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden text-center pb-8">
                            <div class="h-24 bg-gradient-to-br from-blue-700 to-indigo-800"></div>
                            <div class="w-24 h-24 bg-white rounded-full mx-auto -mt-12 p-1 shadow-lg flex items-center justify-center text-4xl text-blue-600 font-black" id="profile-avatar">?</div>
                            <h3 class="text-xl font-black mt-4" id="view-name-card">--</h3>
                            <div class="mt-6 flex justify-around border-t pt-4 px-4 text-[10px]">
                                <div><p class="text-slate-400">Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p><p class="text-red-600 font-black text-lg" id="profile-stat-actions">0</p></div>
                                <div><p class="text-slate-400">Ù…Ù‡Ø§Ù…</p><p class="text-blue-600 font-black text-lg" id="profile-stat-tasks">0</p></div>
                                <div><p class="text-slate-400">Ø¥Ø¬Ø§Ø²Ø§Øª</p><p class="text-emerald-600 font-black text-lg" id="profile-stat-leaves">0</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                            <h4 class="font-black text-slate-800 mb-6 flex items-center gap-3">ğŸ•’ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h4>
                            <div id="scheduleListView" class="space-y-3 text-xs"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-8 space-y-8">
                        <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm relative">
                            <h3 class="font-black text-slate-800 mb-8 border-b pb-4 text-xl">ğŸ“ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…ÙˆØ¸Ù</h3>
                            <div id="detailed-info-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 text-sm"></div>
                        </div>

                        <div class="space-y-8 no-print">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm">
                                    <div class="p-5 bg-red-50 text-red-700 font-black border-b">âš ï¸ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</div>
                                    <table class="w-full text-right text-[10px] font-bold"><tbody id="profileActionsTable" class="divide-y divide-slate-50"></tbody></table>
                                </div>
                                <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm">
                                    <div class="p-5 bg-emerald-50 text-emerald-700 font-black border-b">ğŸŒ´ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</div>
                                    <table class="w-full text-right text-[10px] font-bold"><tbody id="profileLeavesTable" class="divide-y divide-slate-50"></tbody></table>
                                </div>
                            </div>
                            <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm mt-8 no-print">
                                <div class="p-5 bg-orange-50 text-orange-700 font-black border-b flex justify-between items-center">
                                    <span>â³ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 20 Ø³Ø§Ø¹Ø©)</span>
                                    <span id="profile-overtime-stats" class="text-[10px] bg-white px-2 py-1 rounded-lg border border-orange-200"></span>
                                </div>
                                <table class="w-full text-right text-[10px] font-bold"><thead class="bg-slate-50 text-slate-400 border-b"><tr><th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th><th class="p-3">Ø§Ù„Ø³Ø¨Ø¨</th><th class="p-3 text-left">Ø­Ø°Ù</th></tr></thead><tbody id="profileOvertimeTable" class="divide-y divide-slate-50"></tbody></table>
                            </div>
                            <div class="bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-sm">
                                <div class="p-6 bg-slate-900 text-white font-black flex justify-between items-center">
                                    <span>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù…</span>
                                    <select id="taskFilter" onchange="filterProfileTasks()" class="bg-slate-800 text-white text-[10px] border-none rounded-lg px-2 py-1 w-auto outline-none">
                                        <option value="Ø§Ù„ÙƒÙ„">ÙÙ„ØªØ±Ø©: Ø§Ù„ÙƒÙ„</option>
                                        <option value="Ø¹Ù…Ù„ÙŠØ§Øª">Ø¹Ù…Ù„ÙŠØ§Øª</option>
                                        <option value="Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙØ­Ø© + ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙØ­Ø© + ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                                        <option value="Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª">Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª</option>
                                        <option value="Ø±Ø³Ø§Ø¦Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø±ÙŠØ³ØªÙˆÙ…Ø§Ù†">Ø±Ø³Ø§Ø¦Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø±ÙŠØ³ØªÙˆÙ…Ø§Ù†</option>
                                        <option value="Ø§ÙƒØªÙ">Ø§ÙƒØªÙ</option>
                                        <option value="ÙƒÙˆÙ†ØªØ§ÙƒØª">ÙƒÙˆÙ†ØªØ§ÙƒØª</option>
                                        <option value="Ù…ØªØ§Ø¨Ø¹Ø©">Ù…ØªØ§Ø¨Ø¹Ø©</option>
                                    </select>
                                </div>
                                <table class="w-full text-right text-xs"><thead class="bg-slate-50 text-slate-500 font-black border-b"><tr><th class="p-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-4">Ø§Ù„Ù…Ù‡Ù…Ø©</th><th class="p-4 text-center">Ø¬ÙˆØ¯Ø©%</th><th class="p-4 text-center">Ø§Ù„Ø¹Ø¯Ø¯</th></tr></thead><tbody id="tasksListBody" class="divide-y divide-slate-50"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="modalExportOvertime" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl p-8 relative"><button onclick="closeModal('modalExportOvertime')" class="absolute top-6 left-6 text-slate-400 hover:text-red-500 font-black text-xl">âœ–</button><h3 class="text-xl font-black mb-6">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</h3><div class="grid grid-cols-2 gap-4 text-xs font-bold"><div><label>Ù…Ù†</label><input type="date" id="export_start_date"></div><div><label>Ø¥Ù„Ù‰</label><input type="date" id="export_end_date"></div></div><button onclick="downloadOvertimeExcel()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black mt-4">ØªØ­Ù…ÙŠÙ„ Excel</button></div></div>
    <div id="modalAI" class="modal"><div class="bg-white rounded-[2.5rem] w-full max-w-2xl shadow-2xl p-8 flex flex-col max-h-[90vh] relative"><button onclick="closeModal('modalAI')" class="absolute top-6 left-6 text-slate-400 font-black text-xl">âœ–</button><div class="p-4 bg-purple-700 text-white font-black rounded-t-xl">âœ¨ Gemini Ø§Ù„Ø°ÙƒÙŠ</div><div id="aiResultContent" class="p-6 overflow-y-auto flex-1 font-bold text-sm leading-relaxed"></div></div></div>
    
    <div id="modalSchedule" class="modal"><div class="bg-white rounded-[2.5rem] w-full max-w-2xl shadow-2xl p-8 flex flex-col relative max-h-[90vh]"><button onclick="closeModal('modalSchedule')" class="absolute top-6 left-6 text-slate-400 font-black text-xl">âœ–</button><h3 class="text-xl font-black mb-6 text-indigo-700 border-b pb-4">ØªØ®ØµÙŠØµ Ø§Ù„Ø¯ÙˆØ§Ù…</h3><div id="scheduleInputs" class="space-y-4 overflow-y-auto pr-2" style="max-height: 400px;"></div><div class="mt-8 flex gap-3"><button onclick="saveWeeklySchedule()" class="flex-1 bg-indigo-700 text-white py-4 rounded-2xl font-black shadow-lg">Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button></div></div></div>
    
    <div id="modalLeave" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl p-8 relative"><button onclick="closeModal('modalLeave')" class="absolute top-6 left-6 text-slate-400 font-black text-xl">âœ–</button><h3 class="text-xl font-black text-emerald-600 mb-6" id="leaveModalTitle">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©</h3><input type="hidden" id="leave_index"><select id="leave_type"><option>Ø³Ù†ÙˆÙŠØ©</option><option>Ù…Ø±Ø¶ÙŠØ©</option><option>Ø·Ø§Ø±Ø¦Ø©</option></select><div class="grid grid-cols-2 gap-4 mt-2"><input type="date" id="leave_from"><input type="date" id="leave_to"></div><textarea id="leave_reason" placeholder="Ø§Ù„Ø³Ø¨Ø¨" class="mt-2"></textarea><button onclick="saveLeave()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black mt-4">Ø­ÙØ¸</button></div></div>
    <div id="modalOvertime" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl p-8 relative"><button onclick="closeModal('modalOvertime')" class="absolute top-6 left-6 text-slate-400 font-black text-xl">âœ–</button><h3 class="text-xl font-black text-orange-600 mb-6">Ø¥Ø¶Ø§ÙÙŠ</h3><div class="bg-orange-50 p-3 rounded-xl mb-4 text-center font-black text-orange-800">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: <span id="overtime_remaining_display">--</span> Ø³Ø§Ø¹Ø©</div><input type="date" id="overtime_date"><input type="number" id="overtime_hours" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª" class="mt-2"><select id="overtime_reason" class="mt-2"><option>Ø¶ØºØ· Ø¹Ù…Ù„</option><option>Ù†Ù‚Øµ Ø§Ø°Ù†</option></select><button onclick="saveOvertime()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-black mt-4">Ø­ÙØ¸</button></div></div>
    <div id="modalAction" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl p-8 relative"><button onclick="closeModal('modalAction')" class="absolute top-6 left-6 text-slate-400 font-black">âœ–</button><h3 class="text-xl font-black text-red-600 mb-6">Ø¥Ù†Ø°Ø§Ø±</h3><select id="act_type"><option>ØªØ£Ø®ÙŠØ±</option><option>Ù„ÙØª Ù†Ø¸Ø±</option><option>ÙƒØªØ§Ø¨ÙŠ</option></select><input type="date" id="act_date" class="mt-2"><textarea id="act_reason" placeholder="Ø§Ù„Ø³Ø¨Ø¨" class="mt-2"></textarea><button onclick="saveAction()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black mt-4">Ø­ÙØ¸</button></div></div>
    <div id="modalTask" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl p-8 relative"><button onclick="closeModal('modalTask')" class="absolute top-6 left-6 text-slate-400 font-black">âœ–</button><h3 class="text-xl font-black text-blue-600 mb-6">ØªÙ‚ÙŠÙŠÙ… Ù…Ù‡Ù…Ø©</h3><select id="task_type"><option>Ø¹Ù…Ù„ÙŠØ§Øª</option><option>Ù…ØªØ§Ø¨Ø¹Ø©</option><option>Ù…ÙƒØ§Ù„Ù…Ø§Øª</option><option>Ø±Ø³Ø§Ø¦Ù„</option></select><div class="grid grid-cols-2 gap-4 mt-2"><input type="number" id="task_quality" placeholder="Ø§Ù„Ø¬ÙˆØ¯Ø©%"><input type="number" id="task_count" placeholder="Ø§Ù„Ø¹Ø¯Ø¯"></div><input type="date" id="task_date" class="mt-2"><button onclick="saveTask()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black mt-4">Ø­ÙØ¸</button></div></div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAe-WjGh9PtL932wxJPgLSuaslmJWaDC8",
            authDomain: "hr-operation.firebaseapp.com",
            projectId: "hr-operation",
            storageBucket: "hr-operation.firebasestorage.app",
            messagingSenderId: "498775599728",
            appId: "1:498775599728:web:b195dea758f3cf415162b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const employeesCol = db.collection('employees');

        const weekDays = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];
        let employees = [];
        let currentEmpId = null;
        let systemDate = new Date();

        // --- 2. INITIALIZATION & SYNC ---
        window.onload = () => {
            const storedDate = localStorage.getItem('hr_system_date');
            if(storedDate) systemDate = new Date(storedDate);
            updateSystemDateUI();
            
            // Real-time listener
            employeesCol.onSnapshot(snapshot => {
                employees = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
                updateDashboardStats();
                if(!document.getElementById('dashboard').classList.contains('hidden-section')) {
                    renderDashboardSchedule();
                    renderUpcomingBirthdays();
                    renderYearlyLeaves();
                }
                if(!document.getElementById('employees').classList.contains('hidden-section')) {
                    renderEmployeeList();
                }
                // Refresh profile if open
                if(currentEmpId && !document.getElementById('employee-profile').classList.contains('hidden-section')) {
                    viewProfile(currentEmpId);
                }
            });
            showSection('dashboard');
        };

        // --- 3. CORE FUNCTIONS ---
        async function syncUpdate(emp) {
            try {
                const { firestoreId, ...data } = emp;
                await employeesCol.doc(firestoreId).update(data);
            } catch(e) { console.error(e); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©"); }
        }

        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            if(document.getElementById('link-'+id)) document.getElementById('link-'+id).classList.add('active');
            
            if(id === 'dashboard') {
                renderDashboardSchedule();
                renderUpcomingBirthdays();
                renderYearlyLeaves();
            }
        }

        function updateSystemDate() {
            const val = document.getElementById('systemDateSelector').value;
            if(val) {
                systemDate = new Date(val);
                localStorage.setItem('hr_system_date', val);
                updateSystemDateUI();
                renderDashboardSchedule();
            }
        }

        function updateSystemDateUI() {
            document.getElementById('systemDateSelector').value = systemDate.toISOString().split('T')[0];
            document.getElementById('current-date-display').innerText = systemDate.toLocaleDateString('ar-EG', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        }

        // --- 4. EMPLOYEE MANAGEMENT ---
        async function saveNewEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('f_id').value;
            if(employees.some(e => e.id == id)) return alert("Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");

            const newEmp = {
                id: id,
                name: document.getElementById('f_name').value,
                details: {
                    "Ø§Ù„Ù‚Ø³Ù…": document.getElementById('f_dept').value,
                    "Ø§Ù„Ù…Ø³Ù…Ù‰": document.getElementById('f_pos').value,
                    "Ø§Ù„Ø±Ø§ØªØ¨": document.getElementById('f_salary').value,
                    "Ø§Ù„Ù‡Ø§ØªÙ": document.getElementById('f_phone').value,
                    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯": document.getElementById('f_dob').value,
                    "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„": document.getElementById('f_start_date').value,
                    "Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª": document.getElementById('f_leave_bal').value,
                    "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†": document.getElementById('f_address').value,
                    "ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…": document.getElementById('f_blood').value,
                    "Ø§Ù„Ø¬Ù†Ø³ÙŠØ©": document.getElementById('f_nat').value
                },
                schedule: {}, actions: [], tasks: [], leaves: [], overtime: []
            };
            await employeesCol.add(newEmp);
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            showSection('dashboard');
        }

        function renderEmployeeList(data = employees) {
            document.getElementById('employeesTableBody').innerHTML = data.map(emp => `
                <tr class="hover:bg-slate-50 border-b font-bold transition">
                    <td class="p-5">${emp.name} <span class="text-slate-300">#${emp.id}</span></td>
                    <td class="p-5 text-slate-500">${emp.details['Ø§Ù„Ù‚Ø³Ù…']}</td>
                    <td class="p-5 text-center"><button onclick="viewProfile('${emp.id}')" class="bg-blue-50 text-blue-700 px-6 py-2 rounded-2xl font-black text-xs hover:bg-blue-600 hover:text-white transition">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù</button></td>
                </tr>
            `).join('');
        }

        function searchEmployees() {
            const v = document.getElementById('empSearch').value.toLowerCase();
            renderEmployeeList(employees.filter(e => e.name.toLowerCase().includes(v) || e.details['Ø§Ù„Ù‚Ø³Ù…'].toLowerCase().includes(v)));
        }

        // --- 5. PROFILE LOGIC ---
        function viewProfile(id) {
            const emp = employees.find(e => e.id == id);
            if(!emp) return;
            currentEmpId = id;

            document.getElementById('profile-name-header').innerText = emp.name;
            document.getElementById('profile-job-header').innerText = emp.details['Ø§Ù„Ù…Ø³Ù…Ù‰'];
            document.getElementById('view-name-card').innerText = emp.name;
            document.getElementById('profile-avatar').innerText = emp.name.charAt(0);

            // Stats
            document.getElementById('profile-stat-actions').innerText = (emp.actions||[]).length;
            document.getElementById('profile-stat-tasks').innerText = (emp.tasks||[]).length;
            document.getElementById('profile-stat-leaves').innerText = (emp.leaves||[]).length;

            // Details
            let html = Object.entries(emp.details).map(([k,v]) => `
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-[9px] text-slate-400 font-black uppercase mb-1">${k}</p>
                    <p class="text-slate-800 text-xs">${v || '-'}</p>
                </div>
            `).join('');
            
            // Duration Calc
            let durationText = "--";
            if(emp.details['Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„']) {
                const s = new Date(emp.details['Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„']);
                const t = new Date(systemDate);
                if(s <= t) {
                    let y = t.getFullYear() - s.getFullYear();
                    let m = t.getMonth() - s.getMonth();
                    if(m < 0) { y--; m += 12; }
                    durationText = `${y} Ø³Ù†Ø© Ùˆ ${m} Ø´Ù‡Ø±`;
                }
            }
            html += `<div class="bg-blue-50 p-4 rounded-xl border border-blue-200"><p class="text-[9px] text-blue-600 font-black uppercase mb-1">Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</p><p class="text-blue-900 text-xs">${durationText}</p></div>`;
            document.getElementById('detailed-info-grid').innerHTML = html;

            // Schedule View
            const wDates = getWeekDates();
            document.getElementById('scheduleListView').innerHTML = weekDays.map((d, i) => {
                const s = emp.schedule[d] || {type:'Ø¹Ù…Ù„', from:'08:00', to:'16:00'};
                return `<div class="flex justify-between items-center p-3 rounded-xl border ${s.type==='Ø¹Ø·Ù„Ø©'?'bg-red-50 text-red-600':'bg-slate-50'}">
                    <div><span class="block text-[10px]">${d}</span><span class="text-[8px] text-slate-400">${wDates[i].split('-')[2]}/${wDates[i].split('-')[1]}</span></div>
                    <span class="text-[10px] font-black">${s.type==='Ø¹Ø·Ù„Ø©'?'Ø±Ø§Ø­Ø©':s.from+' - '+s.to}</span>
                </div>`;
            }).join('');

            // Tables
            renderProfileTables(emp);
            
            document.getElementById('btn-edit-toggle').classList.remove('hidden');
            document.getElementById('btn-save-changes').classList.add('hidden');
            showSection('employee-profile');
        }

        function renderProfileTables(emp) {
            document.getElementById('profileActionsTable').innerHTML = (emp.actions||[]).map(a => `<tr class="border-b"><td class="p-3 text-[9px]">${a.date}</td><td class="p-3 text-red-600">${a.type}</td><td class="p-3 text-slate-400">${a.reason}</td></tr>`).join('');
            document.getElementById('profileLeavesTable').innerHTML = (emp.leaves||[]).map(l => `<tr class="border-b"><td class="p-3 text-[9px]">${l.from}</td><td class="p-3 text-emerald-600">${l.type}</td><td class="p-3 text-slate-400">${l.reason}</td></tr>`).join('');
            
            const otTotal = (emp.overtime||[]).reduce((sum,x) => sum+parseFloat(x.hours), 0);
            document.getElementById('profile-overtime-stats').innerHTML = `Ù…Ø³ØªØ®Ø¯Ù…: ${otTotal} | Ù…ØªØ¨Ù‚ÙŠ: ${20-otTotal}`;
            document.getElementById('profileOvertimeTable').innerHTML = (emp.overtime||[]).map((o, idx) => `<tr class="border-b"><td class="p-3">${o.date}</td><td class="p-3 text-orange-600">${o.hours} Ø³Ø§Ø¹Ø©</td><td class="p-3">${o.reason}</td><td class="p-3"><button onclick="deleteOvertime(${idx})" class="text-red-500">x</button></td></tr>`).join('');
            
            filterProfileTasks();
        }

        // --- 6. MODAL ACTIONS (Fixed) ---
        
        // SCHEDULE (Fixed)
        function prepareScheduleModal() {
            const emp = employees.find(e => e.id == currentEmpId);
            document.getElementById('scheduleInputs').innerHTML = weekDays.map(d => {
                const s = emp.schedule[d] || {type:'Ø¹Ù…Ù„', from:'08:00', to:'16:00'};
                return `
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-xl border mb-2">
                    <span class="w-16 font-bold text-xs">${d}</span>
                    <select id="type-${d}" onchange="toggleDayRow('${d}')" class="text-xs w-24">
                        <option value="Ø¹Ù…Ù„" ${s.type==='Ø¹Ù…Ù„'?'selected':''}>Ø¹Ù…Ù„</option>
                        <option value="Ø¹Ø·Ù„Ø©" ${s.type==='Ø¹Ø·Ù„Ø©'?'selected':''}>Ø±Ø§Ø­Ø©</option>
                    </select>
                    <div id="times-${d}" class="flex gap-2 flex-1 ${s.type==='Ø¹Ø·Ù„Ø©'?'opacity-25 pointer-events-none':''}">
                        <input type="time" id="from-${d}" value="${s.from}" class="text-xs">
                        <input type="time" id="to-${d}" value="${s.to}" class="text-xs">
                    </div>
                </div>`;
            }).join('');
        }

        function toggleDayRow(d) {
            const type = document.getElementById(`type-${d}`).value;
            const row = document.getElementById(`times-${d}`);
            if(type === 'Ø¹Ø·Ù„Ø©') row.classList.add('opacity-25', 'pointer-events-none');
            else row.classList.remove('opacity-25', 'pointer-events-none');
        }

        async function saveWeeklySchedule() {
            const emp = employees.find(e => e.id == currentEmpId);
            weekDays.forEach(d => {
                emp.schedule[d] = {
                    type: document.getElementById(`type-${d}`).value,
                    from: document.getElementById(`from-${d}`).value,
                    to: document.getElementById(`to-${d}`).value
                };
            });
            await syncUpdate(emp);
            closeModal('modalSchedule');
        }

        // OVERTIME (Fixed)
        function prepareOvertimeModal() {
            const emp = employees.find(e => e.id == currentEmpId);
            const used = (emp.overtime||[]).reduce((s,x) => s + parseFloat(x.hours), 0);
            document.getElementById('overtime_remaining_display').innerText = 20 - used;
            document.getElementById('overtime_date').value = systemDate.toISOString().split('T')[0];
            openModal('modalOvertime');
        }

        async function saveOvertime() {
            const emp = employees.find(e => e.id == currentEmpId);
            const hrs = parseFloat(document.getElementById('overtime_hours').value);
            const used = (emp.overtime||[]).reduce((s,x) => s + parseFloat(x.hours), 0);
            
            if(used + hrs > 20) return alert("ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (20 Ø³Ø§Ø¹Ø©)!");
            
            emp.overtime.push({
                date: document.getElementById('overtime_date').value,
                hours: hrs,
                reason: document.getElementById('overtime_reason').value
            });
            await syncUpdate(emp);
            closeModal('modalOvertime');
        }

        async function deleteOvertime(idx) {
            if(confirm("Ø­Ø°ÙØŸ")) {
                const emp = employees.find(e => e.id == currentEmpId);
                emp.overtime.splice(idx, 1);
                await syncUpdate(emp);
            }
        }

        // OTHER ACTIONS
        async function saveLeave() {
            const emp = employees.find(e => e.id == currentEmpId);
            const from = document.getElementById('leave_from').value;
            const to = document.getElementById('leave_to').value;
            const type = document.getElementById('leave_type').value;
            
            // Simple deduction logic
            if(type === 'Ø³Ù†ÙˆÙŠØ©') {
                const days = Math.ceil((new Date(to) - new Date(from)) / (1000*60*60*24)) + 1;
                emp.details['Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª'] = parseInt(emp.details['Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª']) - days;
            }
            
            emp.leaves.push({ from, to, type, reason: document.getElementById('leave_reason').value });
            await syncUpdate(emp);
            closeModal('modalLeave');
        }

        async function saveAction() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.actions.push({
                type: document.getElementById('act_type').value,
                date: document.getElementById('act_date').value,
                reason: document.getElementById('act_reason').value
            });
            await syncUpdate(emp);
            closeModal('modalAction');
        }

        async function saveTask() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.tasks.push({
                type: document.getElementById('task_type').value,
                date: document.getElementById('task_date').value,
                quality: document.getElementById('task_quality').value,
                count: document.getElementById('task_count').value
            });
            await syncUpdate(emp);
            closeModal('modalTask');
        }

        // --- 7. HELPERS & DASHBOARD ---
        function filterProfileTasks() {
            const emp = employees.find(e => e.id == currentEmpId);
            const filter = document.getElementById('taskFilter').value;
            let tasks = emp.tasks || [];
            if(filter !== 'Ø§Ù„ÙƒÙ„') tasks = tasks.filter(t => t.type === filter);
            document.getElementById('tasksListBody').innerHTML = tasks.map(t => `
                <tr class="border-b hover:bg-slate-50"><td class="p-4">${t.date}</td><td class="p-4">${t.type}</td><td class="p-4 text-center font-black text-blue-600">${t.quality}%</td><td class="p-4 text-center">${t.count}</td></tr>
            `).join('');
        }

        function calculateWorkDuration() {
            const val = document.getElementById('f_start_date').value;
            if(!val) return;
            const s = new Date(val);
            const t = new Date(systemDate);
            let y = t.getFullYear() - s.getFullYear();
            let m = t.getMonth() - s.getMonth();
            if(m < 0) { y--; m += 12; }
            document.getElementById('duration_result').innerText = `${y} Ø³Ù†Ø© Ùˆ ${m} Ø´Ù‡Ø±`;
        }

        function getWeekDates() {
            const d = new Date(systemDate);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 6 ? 0 : -1); // Adjust based on Sat start
            // Simplified logic for Demo: Just standard week around system date
            const arr = [];
            for(let i=0; i<7; i++) {
                const temp = new Date(systemDate);
                temp.setDate(temp.getDate() - temp.getDay() + (i+1)); // Very rough approx for demo
                arr.push(temp.toISOString().split('T')[0]); 
            }
            return arr; 
        }

        function renderDashboardSchedule() {
            const head = document.getElementById('dashboardScheduleHeadRow');
            head.innerHTML = `<th class="p-4 bg-slate-50 sticky right-0">Ø§Ù„Ù…ÙˆØ¸Ù</th>` + weekDays.map(d => `<th class="p-4">${d}</th>`).join('');
            
            document.getElementById('dashboardScheduleTable').innerHTML = employees.map(e => `
                <tr class="border-b">
                    <td class="p-4 bg-slate-50 sticky right-0">${e.name}</td>
                    ${weekDays.map(d => {
                        const s = e.schedule[d] || {from:'08:00'};
                        return `<td class="p-4 text-center text-blue-600">${s.type==='Ø¹Ø·Ù„Ø©'?'Ø±Ø§Ø­Ø©':s.from}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }

        function updateDashboardStats() {
            document.getElementById('stat-emp-count').innerText = employees.length;
            let a=0, l=0;
            employees.forEach(e => { a += (e.actions||[]).length; l += (e.leaves||[]).length; });
            document.getElementById('stat-action-count').innerText = a;
            document.getElementById('stat-leave-count').innerText = l;
        }

        function renderUpcomingBirthdays() {
            const m = systemDate.getMonth();
            const list = employees.filter(e => e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯'] && new Date(e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']).getMonth() === m);
            document.getElementById('birthdayList').innerHTML = list.map(e => `<div class="p-3 bg-slate-50 rounded border mb-2 text-xs font-bold flex justify-between"><span>${e.name}</span><span>${e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']}</span></div>`).join('');
        }

        function renderYearlyLeaves() {
            // Simplified for brevity
            document.getElementById('yearlyLeavesTable').innerHTML = ""; 
        }

        function toggleEditProfile() {
            const emp = employees.find(e => e.id == currentEmpId);
            document.getElementById('btn-edit-toggle').classList.add('hidden');
            document.getElementById('btn-save-changes').classList.remove('hidden');
            document.getElementById('detailed-info-grid').innerHTML = `
                <div class="col-span-full mb-4"><label class="text-xs">Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="edit-name" value="${emp.name}"></div>
            ` + Object.entries(emp.details).map(([k,v]) => `<div><label class="text-[10px]">${k}</label><input type="text" id="edit-${k}" value="${v}"></div>`).join('');
        }

        async function saveProfileChanges() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.name = document.getElementById('edit-name').value;
            Object.keys(emp.details).forEach(k => {
                const el = document.getElementById(`edit-${k}`);
                if(el) emp.details[k] = el.value;
            });
            await syncUpdate(emp);
            viewProfile(currentEmpId);
        }

        async function deleteEmployeeProfile() {
            if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) {
                const emp = employees.find(e => e.id == currentEmpId);
                await employeesCol.doc(emp.firestoreId).delete();
                showSection('dashboard');
            }
        }

        // --- 8. UTILS (Backup, Excel) ---
        function downloadFullBackup() {
            const blob = new Blob([JSON.stringify(employees)], {type:"application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download="backup.json"; a.click();
        }
        
        function downloadOvertimeExcel() {
            alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù…Ø­Ø§ÙƒØ§Ø©)");
            closeModal('modalExportOvertime');
        }

        function openModal(id) { 
            if(id === 'modalSchedule') prepareScheduleModal(); 
            if(id === 'modalOvertime') prepareOvertimeModal();
            document.getElementById(id).classList.add('active'); 
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    </script>
</body>
</html>
