<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… HR Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - v18.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --accent: #facc15; --bg-main: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-main); color: #1e293b; }
        .sidebar-link { transition: all 0.3s ease; cursor: pointer; }
        .sidebar-link.active { background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%); border-left: 4px solid var(--accent); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .hidden-section { display: none; }
        .stat-card { transition: all 0.3s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .modern-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        input, select, textarea { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.6rem 1rem; width: 100%; transition: all 0.2s; background-color: #fff; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .modal { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal.active { display: flex; }
        .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); } 70% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(147, 51, 234, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media print { .no-print { display: none !important; } body { background: white; } main { padding: 0 !important; width: 100% !important; } .print-area { display: block !important; } }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="flex min-h-screen">

    <aside class="w-72 bg-slate-900 text-white flex-shrink-0 hidden lg:flex flex-col shadow-2xl z-50 no-print">
        <div class="p-8">
            <div class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-400">HR PLATFORM âœ¨</div>
            <p class="text-slate-500 text-[10px] mt-1 font-bold uppercase tracking-widest">Ø¥ØµØ¯Ø§Ø± Ø³Ø­Ø§Ø¨ÙŠ 18.0</p>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <div onclick="showSection('dashboard')" class="sidebar-link flex items-center p-3 rounded-xl hover:bg-slate-800 transition active" id="link-dashboard"><span class="ml-3 font-bold">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></div>
            <div onclick="showSection('employees')" class="sidebar-link flex items-center p-3 rounded-xl hover:bg-slate-800 transition" id="link-employees"><span class="ml-3 font-bold">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></div>
            
            <div class="pt-10 px-3 space-y-2">
                <button onclick="downloadFullBackup()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs py-3 rounded-xl border border-slate-700 font-bold transition-all flex items-center justify-center gap-2">ğŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)</button>
                <button onclick="openModal('modalExportOvertime')" class="w-full bg-orange-800/50 hover:bg-orange-700 text-orange-100 text-xs py-3 rounded-xl border border-orange-700 font-bold transition-all flex items-center justify-center gap-2">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</button>
            </div>
        </nav>
        <div class="p-6 border-t border-slate-800">
            <div class="flex items-center gap-3 bg-slate-800/50 p-4 rounded-2xl">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center font-bold">M</div>
                <div><p class="text-sm font-bold text-white">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</p><p class="text-[10px] text-slate-400" id="current-date-display"></p></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="glass-header shadow-sm p-4 flex justify-between items-center z-40 sticky top-0 border-b border-slate-100 no-print">
            <h2 id="section-title" class="text-xl font-extrabold text-slate-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-end">
                    <span class="text-[9px] font-bold text-blue-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                    <input type="date" id="systemDateSelector" onchange="updateSystemDate()" class="bg-slate-50 border-slate-200 text-xs py-1.5 w-40">
                </div>
                <button onclick="showSection('add-employee-form')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg transition-all">+ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 print-area">
            
            <section id="dashboard" class="space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 no-print">
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center">
                        <p class="text-slate-400 font-bold text-[10px] uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                        <h3 class="text-3xl font-black text-slate-800 mt-1" id="stat-emp-count">0</h3>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center">
                        <p class="text-slate-400 font-bold text-[10px] uppercase text-red-500">Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</p>
                        <h3 class="text-3xl font-black text-red-600 mt-1" id="stat-action-count">0</h3>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-3xl border border-slate-50 modern-shadow text-center">
                        <p class="text-slate-400 font-bold text-[10px] uppercase text-emerald-500">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</p>
                        <h3 class="text-3xl font-black text-emerald-600 mt-1" id="stat-leave-count">0</h3>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border border-slate-100 modern-shadow overflow-hidden">
                    <div class="p-8 border-b bg-slate-50/30 font-black text-slate-800 flex justify-between items-center">
                        <span>ğŸ—“ï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</span>
                        <span id="week-date-range" class="text-[10px] text-slate-400 font-bold"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse whitespace-nowrap">
                            <thead class="bg-slate-50 text-slate-500 text-[10px] font-black uppercase tracking-tighter">
                                <tr id="dashboardScheduleHeadRow"></tr>
                            </thead>
                            <tbody id="dashboardScheduleTable" class="divide-y divide-slate-100 text-[11px] font-bold"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="employees" class="hidden-section space-y-6 font-bold">
                <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-4">
                    <input type="text" id="empSearch" onkeyup="searchEmployees()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù…..." class="bg-slate-50 border-none flex-1">
                </div>
                <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
                    <table class="w-full text-right border-collapse">
                        <thead class="bg-slate-50 text-slate-500 text-xs font-black uppercase tracking-wider">
                            <tr><th class="p-5 border-b">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th><th class="p-5 border-b">Ø§Ù„Ù‚Ø³Ù…</th><th class="p-5 border-b text-center">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th></tr>
                        </thead>
                        <tbody id="employeesTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <section id="add-employee-form" class="hidden-section max-w-5xl mx-auto no-print">
                <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-xl">
                    <h2 class="text-3xl font-black text-blue-800 mb-8 flex items-center gap-3">
                        <span>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</span>
                        <button onclick="showSection('dashboard')" class="text-xs bg-slate-100 px-3 py-1 rounded-lg text-slate-500">Ø±Ø¬ÙˆØ¹</button>
                    </h2>
                    <form id="fullEmployeeForm" onsubmit="saveNewEmployee(event)" class="space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="f_name" required></div>
                            <div><label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input type="text" id="f_id" required></div>
                            <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="f_dob"></div>
                            <div><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone"></div>
                            <div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="f_address"></div>
                            <div><label>Ø§Ù„Ù‚Ø³Ù…</label><input type="text" id="f_dept"></div>
                            <div><label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input type="text" id="f_pos"></div>
                            <div><label>Ø§Ù„Ù…Ø±ØªØ¨</label><input type="number" id="f_salary"></div>
                            <div><label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„</label><input type="date" id="f_start_date"></div>
                            <div><label>Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</label><input type="number" id="f_leave_bal" value="30"></div>
                            <div><label>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</label><input type="text" id="f_blood"></div>
                            <div><label>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label><input type="text" id="f_nat"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black text-xl shadow-lg">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                    </form>
                </div>
            </section>

            <section id="employee-profile" class="hidden-section space-y-8 pb-10">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-5">
                        <button onclick="showSection('employees')" class="w-14 h-14 bg-white rounded-3xl shadow-sm flex items-center justify-center text-slate-400 font-black text-xl no-print">â¬…ï¸</button>
                        <div><h2 class="text-3xl font-black text-slate-800" id="profile-name-header">--</h2><p class="text-blue-600 font-black text-sm" id="profile-job-header">--</p></div>
                    </div>
                    <div class="flex flex-wrap gap-2 no-print">
                        <button onclick="window.print()" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button onclick="openModal('modalSchedule')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">ğŸ•’ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
                        <button onclick="openModal('modalAction')" class="bg-red-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">âš ï¸ Ø¥Ù†Ø°Ø§Ø±</button>
                        <button onclick="openModal('modalTask')" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">ğŸ“‹ Ù…Ù‡Ù…Ø©</button>
                        <button onclick="prepareOvertimeModal()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-[10px] font-black">â³ Ø¥Ø¶Ø§ÙÙŠ</button>
                        <button onclick="openModal('modalLeave')" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-[10px] font-black">ğŸŒ´ Ø¥Ø¬Ø§Ø²Ø©</button>
                        <button onclick="deleteEmployeeProfile()" class="bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-xl text-[10px] font-black">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 space-y-8">
                        <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden text-center pb-8">
                            <div class="h-24 bg-gradient-to-br from-blue-700 to-indigo-800"></div>
                            <div class="w-24 h-24 bg-white rounded-full mx-auto -mt-12 p-1 shadow-lg flex items-center justify-center text-4xl text-blue-600 font-black" id="profile-avatar">?</div>
                            <h3 class="text-xl font-black mt-4" id="view-name-card">--</h3>
                            <div class="mt-6 flex justify-around border-t pt-4 px-4 text-[10px]">
                                <div><p class="text-slate-400">Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p><p class="text-red-600 font-black text-lg" id="profile-stat-actions">0</p></div>
                                <div><p class="text-slate-400">Ù…Ù‡Ø§Ù…</p><p class="text-blue-600 font-black text-lg" id="profile-stat-tasks">0</p></div>
                                <div><p class="text-slate-400">Ø¥Ø¬Ø§Ø²Ø§Øª</p><p class="text-emerald-600 font-black text-lg" id="profile-stat-leaves">0</p></div>
                            </div>
                        </div>
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100">
                            <h4 class="font-black text-slate-800 mb-6">ğŸ•’ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h4>
                            <div id="scheduleListView" class="space-y-3 text-xs"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-8 space-y-8">
                        <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm">
                            <h3 class="font-black text-slate-800 mb-8 border-b pb-4 text-xl">ğŸ“ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ</h3>
                            <div id="detailed-info-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 text-sm font-bold"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 no-print">
                            <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm">
                                <div class="p-5 bg-red-50 text-red-700 font-black border-b">âš ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</div>
                                <table class="w-full text-right text-[10px] font-bold"><tbody id="profileActionsTable" class="divide-y divide-slate-50"></tbody></table>
                            </div>
                            <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm">
                                <div class="p-5 bg-emerald-50 text-emerald-700 font-black border-b">ğŸŒ´ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</div>
                                <table class="w-full text-right text-[10px] font-bold"><tbody id="profileLeavesTable" class="divide-y divide-slate-50"></tbody></table>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-[2rem] border overflow-hidden shadow-sm no-print">
                            <div class="p-5 bg-orange-50 text-orange-700 font-black border-b flex justify-between">
                                <span>â³ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø­Ø¯ 20 Ø³Ø§Ø¹Ø©)</span>
                                <span id="profile-overtime-stats" class="text-xs"></span>
                            </div>
                            <table class="w-full text-right text-[10px] font-bold"><tbody id="profileOvertimeTable" class="divide-y divide-slate-50"></tbody></table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="modalSchedule" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-2xl p-8 relative shadow-2xl"><button onclick="closeModal('modalSchedule')" class="absolute top-4 left-4 font-bold text-red-500">Ø¥ØºÙ„Ø§Ù‚</button><h3 class="text-xl font-black mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…</h3><div id="scheduleInputs" class="space-y-2"></div><button onclick="saveWeeklySchedule()" class="w-full bg-indigo-600 text-white py-3 rounded-xl mt-4 font-bold">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button></div></div>
    <div id="modalLeave" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative"><button onclick="closeModal('modalLeave')" class="absolute top-4 left-4 font-bold text-red-500">Ø¥ØºÙ„Ø§Ù‚</button><h3 class="text-xl font-black mb-4">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©</h3><select id="leave_type" class="mb-4"><option>Ø³Ù†ÙˆÙŠØ©</option><option>Ù…Ø±Ø¶ÙŠØ©</option><option>Ø·Ø§Ø±Ø¦Ø©</option></select><div class="grid grid-cols-2 gap-2 mb-4"><input type="date" id="leave_from"><input type="date" id="leave_to"></div><textarea id="leave_reason" placeholder="Ø§Ù„Ø³Ø¨Ø¨" class="mb-4"></textarea><button onclick="saveLeave()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸</button></div></div>
    <div id="modalOvertime" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative"><h3 class="text-xl font-black mb-4 text-orange-600">ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ</h3><input type="date" id="overtime_date" class="mb-4"><input type="number" id="overtime_hours" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª" class="mb-4"><select id="overtime_reason" class="mb-4"><option>Ù†Ù‚Øµ Ø§Ø°Ù†</option><option>Ø¶ØºØ· Ø¹Ù…Ù„</option></select><button onclick="saveOvertime()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸</button><button onclick="closeModal('modalOvertime')" class="mt-2 w-full text-slate-400">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="modalAction" class="modal"><div class="bg-white rounded-[2rem] w-full max-w-md p-8 relative shadow-2xl"><h3 class="text-xl font-black mb-4 text-red-600">ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†Ø°Ø§Ø±</h3><select id="act_type" class="mb-4"><option>ØªØ£Ø®ÙŠØ±</option><option>Ø¥Ù†Ø°Ø§Ø± ÙƒØªØ§Ø¨ÙŠ</option></select><input type="date" id="act_date" class="mb-4"><textarea id="act_reason" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„" class="mb-4"></textarea><button onclick="saveAction()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸</button><button onclick="closeModal('modalAction')" class="mt-2 w-full text-slate-400">Ø¥Ù„ØºØ§Ø¡</button></div></div>

    <script>
        // --- 1. Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAe-WjGh9PtL932wxJPgLSuaslmJWaDC8",
            authDomain: "hr-operation.firebaseapp.com",
              databaseURL: "https://hr-operation-default-rtdb.firebaseio.com",
            projectId: "hr-operation",
            storageBucket: "hr-operation.firebasestorage.app",
            messagingSenderId: "498775599728",
            appId: "1:498775599728:web:b195dea758f3cf415162b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const employeesCol = db.collection('employees');

        // --- 2. Global Variables ---
        let employees = [];
        let currentEmpId = null;
        let systemDate = new Date();
        const weekDays = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];

        // --- 3. Core Logic & Real-time Sync ---
        function loadData() {
            employeesCol.onSnapshot(snapshot => {
                employees = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
                updateDashboardStats();
                if (document.getElementById('employees').classList.contains('hidden-section') === false) renderEmployeeList();
                if (document.getElementById('dashboard').classList.contains('hidden-section') === false) renderDashboardSchedule();
            });
        }

        async function syncUpdate(emp) {
            try {
                const { firestoreId, ...data } = emp;
                await employeesCol.doc(firestoreId).update(data);
            } catch (e) { console.error("Sync Error:", e); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©"); }
        }

        // --- 4. Navigation & UI ---
        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const link = document.getElementById('link-' + id);
            if (link) link.classList.add('active');
            
            if(id === 'dashboard') renderDashboardSchedule();
            if(id === 'employees') renderEmployeeList();
        }

        function openModal(id) { 
            if(id === 'modalSchedule') prepareScheduleModal(); 
            document.getElementById(id).classList.add('active'); 
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- 5. Employee Management ---
        async function saveNewEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('f_id').value;
            if(employees.some(emp => emp.id == id)) return alert("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!");

            const newEmp = {
                id: id,
                name: document.getElementById('f_name').value,
                details: {
                    "Ø§Ù„Ù‚Ø³Ù…": document.getElementById('f_dept').value,
                    "Ø§Ù„Ù…Ø³Ù…Ù‰": document.getElementById('f_pos').value,
                    "Ø§Ù„Ø±Ø§ØªØ¨": document.getElementById('f_salary').value,
                    "Ø§Ù„Ù‡Ø§ØªÙ": document.getElementById('f_phone').value,
                    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯": document.getElementById('f_dob').value,
                    "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„": document.getElementById('f_start_date').value,
                    "Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª": document.getElementById('f_leave_bal').value
                },
                schedule: {}, actions: [], tasks: [], leaves: [], overtime: []
            };

            await employeesCol.add(newEmp);
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
            showSection('dashboard');
        }

        function renderEmployeeList(data = employees) {
            document.getElementById('employeesTableBody').innerHTML = data.map(emp => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="p-5">${emp.name} <span class="text-slate-300">#${emp.id}</span></td>
                    <td class="p-5 text-slate-500">${emp.details['Ø§Ù„Ù‚Ø³Ù…']}</td>
                    <td class="p-5 text-center">
                        <button onclick="viewProfile('${emp.id}')" class="bg-blue-50 text-blue-700 px-8 py-2 rounded-2xl font-black text-xs hover:bg-blue-600 hover:text-white transition-all">Ø¹Ø±Ø¶</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- 6. Profile & Details ---
        function viewProfile(id) {
            currentEmpId = id;
            const emp = employees.find(e => e.id == id);
            document.getElementById('profile-name-header').innerText = emp.name;
            document.getElementById('profile-job-header').innerText = emp.details['Ø§Ù„Ù…Ø³Ù…Ù‰'];
            document.getElementById('view-name-card').innerText = emp.name;
            document.getElementById('profile-avatar').innerText = emp.name[0];
            
            renderDetailedGrid(emp);
            renderScheduleView(emp);
            renderActionTable(emp);
            renderLeaveTable(emp);
            renderOvertimeTable(emp);
            updateProfileStats(emp);
            showSection('employee-profile');
        }

        function renderDetailedGrid(emp) {
            document.getElementById('detailed-info-grid').innerHTML = Object.entries(emp.details).map(([k,v]) => `
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <p class="text-[9px] text-slate-400 uppercase mb-1 font-black">${k}</p>
                    <p class="text-slate-800">${v || '-'}</p>
                </div>
            `).join('');
        }

        // --- 7. Modals Actions (Saves to Firebase) ---
        async function saveAction() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.actions.push({
                type: document.getElementById('act_type').value,
                date: document.getElementById('act_date').value,
                reason: document.getElementById('act_reason').value
            });
            await syncUpdate(emp);
            viewProfile(currentEmpId);
            closeModal('modalAction');
        }

        async function saveOvertime() {
            const emp = employees.find(e => e.id == currentEmpId);
            const hrs = parseFloat(document.getElementById('overtime_hours').value);
            const used = (emp.overtime || []).reduce((s, r) => s + parseFloat(r.hours), 0);
            
            if (used + hrs > 20) return alert("ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (20 Ø³Ø§Ø¹Ø©)!");
            
            emp.overtime.push({
                date: document.getElementById('overtime_date').value,
                hours: hrs,
                reason: document.getElementById('overtime_reason').value
            });
            await syncUpdate(emp);
            viewProfile(currentEmpId);
            closeModal('modalOvertime');
        }

        async function saveLeave() {
            const emp = employees.find(e => e.id == currentEmpId);
            const type = document.getElementById('leave_type').value;
            const from = document.getElementById('leave_from').value;
            const to = document.getElementById('leave_to').value;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
            const days = Math.ceil((new Date(to) - new Date(from)) / (1000*60*60*24)) + 1;
            if (type === 'Ø³Ù†ÙˆÙŠØ©') emp.details['Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª'] -= days;

            emp.leaves.push({ type, from, to, reason: document.getElementById('leave_reason').value });
            await syncUpdate(emp);
            viewProfile(currentEmpId);
            closeModal('modalLeave');
        }

        async function deleteEmployeeProfile() {
            if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) {
                const emp = employees.find(e => e.id == currentEmpId);
                await employeesCol.doc(emp.firestoreId).delete();
                showSection('dashboard');
            }
        }

        // --- 8. Schedule Logic ---
        function prepareScheduleModal() {
            const emp = employees.find(e => e.id == currentEmpId);
            document.getElementById('scheduleInputs').innerHTML = weekDays.map(day => {
                const s = emp.schedule[day] || { type: 'Ø¹Ù…Ù„', from: '08:00', to: '16:00' };
                return `
                    <div class="flex items-center gap-2 bg-slate-50 p-2 rounded-xl text-xs font-bold">
                        <span class="w-12">${day}</span>
                        <select id="type-${day}" class="w-20"><option value="Ø¹Ù…Ù„" ${s.type==='Ø¹Ù…Ù„'?'selected':''}>Ø¹Ù…Ù„</option><option value="Ø¹Ø·Ù„Ø©" ${s.type==='Ø¹Ø·Ù„Ø©'?'selected':''}>Ø±Ø§Ø­Ø©</option></select>
                        <input type="time" id="from-${day}" value="${s.from}" class="w-24">
                        <input type="time" id="to-${day}" value="${s.to}" class="w-24">
                    </div>`;
            }).join('');
        }

        async function saveWeeklySchedule() {
            const emp = employees.find(e => e.id == currentEmpId);
            weekDays.forEach(day => {
                emp.schedule[day] = {
                    type: document.getElementById(`type-${day}`).value,
                    from: document.getElementById(`from-${day}`).value,
                    to: document.getElementById(`to-${day}`).value
                };
            });
            await syncUpdate(emp);
            viewProfile(currentEmpId);
            closeModal('modalSchedule');
        }

        // --- 9. Dashboard Stats & Calculations ---
        function updateDashboardStats() {
            document.getElementById('stat-emp-count').innerText = employees.length;
            let a = 0, l = 0;
            employees.forEach(e => { a += (e.actions || []).length; l += (e.leaves || []).length; });
            document.getElementById('stat-action-count').innerText = a;
            document.getElementById('stat-leave-count').innerText = l;
        }

        function updateSystemDate() {
            const val = document.getElementById('systemDateSelector').value;
            if (val) {
                systemDate = new Date(val);
                document.getElementById('current-date-display').innerText = systemDate.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long' });
                renderDashboardSchedule();
            }
        }

        // --- Initialize ---
        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('systemDateSelector').value = today;
            updateSystemDate();
            loadData();
            showSection('dashboard');
        };

        // Helpers for tables
        function renderActionTable(emp) { document.getElementById('profileActionsTable').innerHTML = (emp.actions||[]).map(a => `<tr class="border-b"><td class="p-2">${a.date}</td><td class="p-2 text-red-600">${a.type}</td><td class="p-2">${a.reason}</td></tr>`).join(''); }
        function renderLeaveTable(emp) { document.getElementById('profileLeavesTable').innerHTML = (emp.leaves||[]).map(l => `<tr class="border-b"><td class="p-2">${l.from}</td><td class="p-2 text-emerald-600">${l.type}</td></tr>`).join(''); }
        function renderOvertimeTable(emp) { 
            const recs = emp.overtime || [];
            const total = recs.reduce((s, r) => s + parseFloat(r.hours), 0);
            document.getElementById('profile-overtime-stats').innerText = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} / 20`;
            document.getElementById('profileOvertimeTable').innerHTML = recs.map(o => `<tr class="border-b"><td class="p-2">${o.date}</td><td class="p-2 text-orange-600">${o.hours} Ø³Ø§Ø¹Ø©</td><td class="p-2">${o.reason}</td></tr>`).join('');
        }
        function renderScheduleView(emp) {
            document.getElementById('scheduleListView').innerHTML = weekDays.map(d => {
                const s = emp.schedule[d] || {type: 'Ø¹Ù…Ù„', from: '08:00', to: '16:00'};
                return `<div class="flex justify-between p-2 bg-slate-50 rounded-lg"><span>${d}</span><span>${s.type==='Ø¹Ø·Ù„Ø©'?'Ø±Ø§Ø­Ø©':s.from + ' - ' + s.to}</span></div>`;
            }).join('');
        }
        function renderDashboardSchedule() {
            const table = document.getElementById('dashboardScheduleTable');
            table.innerHTML = employees.map(emp => `
                <tr class="border-b">
                    <td class="p-4 bg-slate-50 sticky right-0">${emp.name}</td>
                    ${weekDays.map(day => {
                        const s = emp.schedule[day] || {type:'Ø¹Ù…Ù„', from:'08:00', to:'16:00'};
                        return `<td class="p-4 text-center ${s.type==='Ø¹Ø·Ù„Ø©'?'text-red-400':'text-blue-600'}">${s.type==='Ø¹Ø·Ù„Ø©'?'Ø±Ø§Ø­Ø©':s.from}</td>`;
                    }).join('')}
                </tr>
            `).join('');
            
            document.getElementById('dashboardScheduleHeadRow').innerHTML = `<th class="p-4 sticky right-0 bg-slate-50">Ø§Ù„Ù…ÙˆØ¸Ù</th>` + weekDays.map(d => `<th class="p-4">${d}</th>`).join('');
        }
    </script>
</body>
</html>

