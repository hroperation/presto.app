<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… HR Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ÙŠØ© v18.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --accent: #facc15; --bg-main: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-main); color: #1e293b; }
        .sidebar-link { transition: all 0.3s ease; cursor: pointer; }
        .sidebar-link.active { background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%); border-left: 4px solid var(--accent); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .hidden-section { display: none; }
        .modal { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal.active { display: flex; }
        .stat-card { transition: all 0.3s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        input, select, textarea { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.6rem 1rem; width: 100%; background: #fff; }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="flex min-h-screen">

    <aside class="w-72 bg-slate-900 text-white flex-shrink-0 hidden lg:flex flex-col no-print">
        <div class="p-8">
            <div class="text-2xl font-extrabold text-blue-400">HR PLATFORM âœ¨</div>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</p>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <div onclick="showSection('dashboard')" id="link-dashboard" class="sidebar-link p-3 rounded-xl hover:bg-slate-800 active">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
            <div onclick="showSection('employees')" id="link-employees" class="sidebar-link p-3 rounded-xl hover:bg-slate-800">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white/90 backdrop-blur shadow-sm p-4 flex justify-between items-center z-40 no-print">
            <h2 id="section-title" class="text-xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div class="flex items-center gap-3">
                <input type="date" id="systemDateSelector" onchange="updateSystemDate()" class="text-xs py-1.5 w-40">
                <button onclick="showSection('add-employee-form')" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-sm font-bold">+ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 print-area">
            
            <section id="dashboard" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 no-print">
                    <div class="stat-card bg-white p-6 rounded-3xl shadow-sm border border-slate-50 text-center">
                        <p class="text-slate-400 text-xs font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                        <h3 class="text-3xl font-black mt-1" id="stat-emp-count">0</h3>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-3xl shadow-sm border border-slate-50 text-center">
                        <p class="text-red-400 text-xs font-bold">Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p>
                        <h3 class="text-3xl font-black mt-1 text-red-600" id="stat-action-count">0</h3>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-3xl shadow-sm border border-slate-50 text-center">
                        <p class="text-emerald-400 text-xs font-bold">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</p>
                        <h3 class="text-3xl font-black mt-1 text-emerald-600" id="stat-leave-count">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <div class="lg:col-span-3 bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b bg-slate-50 font-bold">ğŸ—“ï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right border-collapse">
                                <thead class="bg-slate-100 text-[10px] text-slate-500 uppercase">
                                    <tr id="dashboardScheduleHeadRow"></tr>
                                </thead>
                                <tbody id="dashboardScheduleTable" class="text-[11px] font-bold"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden h-fit">
                        <div class="p-5 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold">ğŸ‚ Ø£Ø¹ÙŠØ§Ø¯ Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±</div>
                        <div id="birthdayList" class="p-4 space-y-3"></div>
                    </div>
                </div>
            </section>

            <section id="employees" class="hidden-section space-y-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm"><input type="text" id="empSearch" onkeyup="searchEmployees()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..."></div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <table class="w-full text-right border-collapse">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><tr><th class="p-4">Ø§Ù„Ø§Ø³Ù…</th><th class="p-4">Ø§Ù„Ù‚Ø³Ù…</th><th class="p-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                        <tbody id="employeesTableBody" class="font-bold"></tbody>
                    </table>
                </div>
            </section>

            <section id="add-employee-form" class="hidden-section max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100">
                    <h2 class="text-2xl font-black mb-6">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h2>
                    <form id="fullEmployeeForm" onsubmit="saveNewEmployee(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="text-xs font-bold">Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="f_name" required></div>
                            <div><label class="text-xs font-bold">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input type="text" id="f_id" required></div>
                            <div><label class="text-xs font-bold">Ø§Ù„Ù‚Ø³Ù…</label><input type="text" id="f_dept"></div>
                            <div><label class="text-xs font-bold">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input type="text" id="f_pos"></div>
                            <div><label class="text-xs font-bold">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="f_dob"></div>
                            <div><label class="text-xs font-bold">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„</label><input type="date" id="f_start_date"></div>
                            <div><label class="text-xs font-bold">Ø§Ù„Ù…Ø±ØªØ¨</label><input type="number" id="f_salary"></div>
                            <div><label class="text-xs font-bold">Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</label><input type="number" id="f_leave_bal" value="30"></div>
                            <div><label class="text-xs font-bold">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="f_phone"></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
                    </form>
                </div>
            </section>

            <section id="employee-profile" class="hidden-section space-y-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button onclick="showSection('employees')" class="bg-white p-3 rounded-xl shadow-sm">â¬…ï¸</button>
                        <div><h2 id="profile-name-header" class="text-2xl font-black">--</h2><p id="profile-job-header" class="text-blue-600 font-bold text-sm">--</p></div>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="openModal('modalAction')" class="bg-red-600 text-white px-4 py-2 rounded-xl text-xs font-bold">âš ï¸ Ø¥Ù†Ø°Ø§Ø±</button>
                        <button onclick="openModal('modalLeave')" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold">ğŸŒ´ Ø¥Ø¬Ø§Ø²Ø©</button>
                        <button onclick="prepareOvertimeModal()" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-xs font-bold">â³ Ø¥Ø¶Ø§ÙÙŠ</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-[2rem] shadow-sm text-center">
                        <div class="w-20 h-20 bg-blue-100 rounded-full mx-auto flex items-center justify-center text-3xl text-blue-600 font-black mb-4" id="profile-avatar">?</div>
                        <div class="flex justify-around border-t pt-4 text-[10px] font-bold">
                            <div><p class="text-slate-400">Ø¥Ù†Ø°Ø§Ø±Ø§Øª</p><p id="p-stat-a" class="text-red-600 text-lg">0</p></div>
                            <div><p class="text-slate-400">Ø¥Ø¬Ø§Ø²Ø§Øª</p><p id="p-stat-l" class="text-emerald-600 text-lg">0</p></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-8 rounded-[2rem] shadow-sm">
                        <h4 class="font-bold border-b pb-2 mb-4">ğŸ“ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ</h4>
                        <div id="detailed-info-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 font-bold text-xs"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="modalLeave" class="modal"><div class="bg-white rounded-3xl p-8 w-full max-w-md"><h3>Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©</h3><input type="date" id="leave_from" class="mt-4"><input type="date" id="leave_to" class="mt-2"><select id="leave_type" class="mt-2"><option>Ø³Ù†ÙˆÙŠØ©</option><option>Ù…Ø±Ø¶ÙŠØ©</option></select><button onclick="saveLeave()" class="w-full bg-emerald-600 text-white py-3 rounded-xl mt-4">Ø­ÙØ¸</button><button onclick="closeModal('modalLeave')" class="w-full mt-2 text-slate-400">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="modalAction" class="modal"><div class="bg-white rounded-3xl p-8 w-full max-w-md"><h3>ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†Ø°Ø§Ø±</h3><select id="act_type" class="mt-4"><option>ØªØ£Ø®ÙŠØ±</option><option>ÙƒØªØ§Ø¨ÙŠ</option></select><input type="date" id="act_date" class="mt-2"><textarea id="act_reason" class="mt-2" placeholder="Ø§Ù„Ø³Ø¨Ø¨"></textarea><button onclick="saveAction()" class="w-full bg-red-600 text-white py-3 rounded-xl mt-4">Ø­ÙØ¸</button><button onclick="closeModal('modalAction')" class="w-full mt-2 text-slate-400">Ø¥Ù„ØºØ§Ø¡</button></div></div>
    <div id="modalOvertime" class="modal"><div class="bg-white rounded-3xl p-8 w-full max-w-md"><h3>ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ</h3><input type="date" id="over_date" class="mt-4"><input type="number" id="over_hrs" placeholder="Ø§Ù„Ø³Ø§Ø¹Ø§Øª" class="mt-2"><button onclick="saveOvertime()" class="w-full bg-orange-600 text-white py-3 rounded-xl mt-4">Ø­ÙØ¸</button><button onclick="closeModal('modalOvertime')" class="w-full mt-2 text-slate-400">Ø¥Ù„ØºØ§Ø¡</button></div></div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAAe-WjGh9PtL932wxJPgLSuaslmJWaDC8",
            authDomain: "hr-operation.firebaseapp.com",
            projectId: "hr-operation",
            storageBucket: "hr-operation.firebasestorage.app",
            messagingSenderId: "498775599728",
            appId: "1:498775599728:web:b195dea758f3cf415162b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const employeesCol = db.collection('employees');

        let employees = [];
        let currentEmpId = null;
        let systemDate = new Date();
        const weekDays = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];

        // Data Management
        function loadData() {
            employeesCol.onSnapshot(snapshot => {
                employees = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
                updateStats();
                renderUpcomingBirthdays();
                if (!document.getElementById('dashboard').classList.contains('hidden-section')) renderDashboardSchedule();
                if (!document.getElementById('employees').classList.contains('hidden-section')) renderEmployeeList();
            });
        }

        async function syncUpdate(emp) {
            const { firestoreId, ...data } = emp;
            await employeesCol.doc(firestoreId).update(data);
        }

        // Navigation
        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            if(document.getElementById('link-'+id)) document.getElementById('link-'+id).classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // Employee Logic
        async function saveNewEmployee(e) {
            e.preventDefault();
            const newEmp = {
                id: document.getElementById('f_id').value,
                name: document.getElementById('f_name').value,
                details: {
                    "Ø§Ù„Ù‚Ø³Ù…": document.getElementById('f_dept').value,
                    "Ø§Ù„Ù…Ø³Ù…Ù‰": document.getElementById('f_pos').value,
                    "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„": document.getElementById('f_start_date').value,
                    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯": document.getElementById('f_dob').value,
                    "Ø§Ù„Ù…Ø±ØªØ¨": document.getElementById('f_salary').value,
                    "Ø§Ù„Ù‡Ø§ØªÙ": document.getElementById('f_phone').value,
                    "Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª": document.getElementById('f_leave_bal').value
                },
                schedule: {}, actions: [], leaves: [], overtime: []
            };
            await employeesCol.add(newEmp);
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
            showSection('dashboard');
        }

        function renderEmployeeList(data = employees) {
            document.getElementById('employeesTableBody').innerHTML = data.map(emp => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-4">${emp.name}</td>
                    <td class="p-4 text-slate-500">${emp.details['Ø§Ù„Ù‚Ø³Ù…']}</td>
                    <td class="p-4 text-center"><button onclick="viewProfile('${emp.id}')" class="bg-blue-600 text-white px-4 py-1 rounded-lg text-xs">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù</button></td>
                </tr>
            `).join('');
        }

        function viewProfile(id) {
            currentEmpId = id;
            const emp = employees.find(e => e.id == id);
            if(!emp) return;

            document.getElementById('profile-name-header').innerText = emp.name;
            document.getElementById('profile-job-header').innerText = emp.details['Ø§Ù„Ù…Ø³Ù…Ù‰'];
            document.getElementById('profile-avatar').innerText = emp.name[0];
            
            // Statistics
            document.getElementById('p-stat-a').innerText = (emp.actions || []).length;
            document.getElementById('p-stat-l').innerText = (emp.leaves || []).length;

            // Details & Work Duration
            const start = new Date(emp.details['Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„']);
            const now = new Date(systemDate);
            let diff = "";
            if(start <= now) {
                let years = now.getFullYear() - start.getFullYear();
                let months = now.getMonth() - start.getMonth();
                if (months < 0) { years--; months += 12; }
                diff = `${years} Ø³Ù†Ø© Ùˆ ${months} Ø´Ù‡Ø±`;
            }

            let html = Object.entries(emp.details).map(([k,v]) => `<div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[9px] text-slate-400 uppercase">${k}</p><p>${v || '-'}</p></div>`).join('');
            html += `<div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-blue-800"><p class="text-[9px] uppercase">Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</p><p>${diff}</p></div>`;
            
            document.getElementById('detailed-info-grid').innerHTML = html;
            showSection('employee-profile');
        }

        // Stats & Birthdays
        function updateStats() {
            document.getElementById('stat-emp-count').innerText = employees.length;
            let a = 0, l = 0;
            employees.forEach(e => { a += (e.actions || []).length; l += (e.leaves || []).length; });
            document.getElementById('stat-action-count').innerText = a;
            document.getElementById('stat-leave-count').innerText = l;
        }

        function renderUpcomingBirthdays() {
            const currentMonth = new Date(systemDate).getMonth();
            const list = employees.filter(e => {
                if(!e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']) return false;
                return new Date(e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']).getMonth() === currentMonth;
            });
            document.getElementById('birthdayList').innerHTML = list.map(e => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100 text-[11px] font-bold">
                    <span>${e.name}</span>
                    <span class="text-blue-600">${e.details['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯']}</span>
                </div>
            `).join('') || '<p class="text-center text-xs text-slate-400 italic">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹ÙŠØ§Ø¯ Ù…ÙŠÙ„Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>';
        }

        // Actions
        async function saveLeave() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.leaves.push({ type: document.getElementById('leave_type').value, from: document.getElementById('leave_from').value, to: document.getElementById('leave_to').value });
            await syncUpdate(emp);
            closeModal('modalLeave');
            viewProfile(currentEmpId);
        }

        async function saveAction() {
            const emp = employees.find(e => e.id == currentEmpId);
            emp.actions.push({ type: document.getElementById('act_type').value, date: document.getElementById('act_date').value, reason: document.getElementById('act_reason').value });
            await syncUpdate(emp);
            closeModal('modalAction');
            viewProfile(currentEmpId);
        }

        // Dashboard Schedule
        function renderDashboardSchedule() {
            const head = document.getElementById('dashboardScheduleHeadRow');
            head.innerHTML = `<th class="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th>` + weekDays.map(d => `<th class="p-3">${d}</th>`).join('');
            document.getElementById('dashboardScheduleTable').innerHTML = employees.map(emp => `
                <tr class="border-b">
                    <td class="p-3 bg-slate-50 sticky right-0 font-bold">${emp.name}</td>
                    ${weekDays.map(d => `<td class="p-3 text-center text-blue-600">${(emp.schedule[d]||{from:'08:00'}).from}</td>`).join('')}
                </tr>
            `).join('');
        }

        function updateSystemDate() {
            systemDate = new Date(document.getElementById('systemDateSelector').value);
            loadData();
        }

        window.onload = () => {
            document.getElementById('systemDateSelector').value = new Date().toISOString().split('T')[0];
            loadData();
        };
    </script>
</body>
</html>
